CREATE OR REPLACE PACKAGE BODY TEST.VDECOUNI IS

    PROCEDURE PONUSUARIO(MICODZONA NUMBER) IS
       MICODOPE VDUSUARIO.CODOPE%TYPE;
      BEGIN
        SELECT CODOPE INTO MICODOPE FROM VDZONAS WHERE CODZONA=MICODZONA;
        IF MICODOPE IS NOT  NULL THEN VDUSER.SETUSER(MICODOPE);
         END IF;
      END;
     
  FUNCTION DAMECODMOV(MIIDINFOPICK NUMBER,MINUMDISP NUMBER) RETURN NUMBER IS
       CURSOR C1 IS SELECT MOV.CODMOV,MOV.CODART,IDI.CODZONA
           FROM VDMOVIM MOV ,VDBULTOLIN BUL,VDBULTOCAB BUC,VDINFODISP IDI,VDBULTOZONA BUZ
           WHERE MOV.CODMOV=BUL.CODMOV AND
                 BUL.CODBULTO=BUC.CODBULTO AND IDI.CODUBI=MOV.CODUBIORI AND  BUC.STATUS<VDST.FBUCPREPARADO AND
                 MOV.STATUS IN (VDST.FMOVPDTERECOGE,VDST.FMOVPDTESTOCK) AND IDI.IDINFOPICK=MIIDINFOPICK AND IDI.NUMDISP=MINUMDISP AND BUZ.CODZONA=IDI.CODZONA AND 
                 BUZ.CODBULTO=BUC.CODBULTO AND BUZ.STATUS=VDST.FBZOENCURSO
           ORDER BY BUZ.SEQBULTO,MOV.CODMOV;
       BEGIN
         FOR I IN C1 LOOP
                 RETURN I.CODMOV;
          END LOOP;
         RETURN 0;
       END;
       
     
  FUNCTION DAMECOLORZONA(MICODZONA NUMBER) RETURN VARCHAR2 IS
    MICOLOROPE VDBULTOZONA.CODOPE%TYPE;
    BEGIN
      SELECT COLORZONA INTO MICOLOROPE FROM VDZONAS WHERE CODZONA=MICODZONA;              
      RETURN NVL(MICOLOROPE,'ROJO;3');
      EXCEPTION WHEN NO_DATA_FOUND THEN RETURN 'ROJO;3';
    END; 
     
  FUNCTION DAMECOLORMOV(MICODMOV NUMBER) RETURN VARCHAR2 IS
    MICOLOROPE VDBULTOZONA.CODOPE%TYPE;
    BEGIN
      SELECT ZON.COLORZONA INTO MICOLOROPE
        FROM VDMOVIM MOV,VDUBICA UBI,VDZONAS ZON
        WHERE MOV.CODMOV=MICODMOV AND MOV.CODUBIORI=UBI.CODUBI AND ZON.CODZONA=UBI.CODZONA;
      RETURN MICOLOROPE;
      EXCEPTION WHEN NO_DATA_FOUND THEN RETURN 'ROJO;3';
    END;  
    
  FUNCTION DAMEBULTOMOV(MICODMOV NUMBER) RETURN VARCHAR2 IS
    MICODBULTO VDBULTOZONA.CODBULTO%TYPE;
    BEGIN
      SELECT BUL.CODBULTO INTO MICODBULTO
        FROM VDMOVIM MOV,VDBULTOLIN BUL
        WHERE MOV.CODMOV=BUL.CODMOV AND MOV.CODMOV=MICODMOV;
      RETURN MICODBULTO;
    END;  
    
   FUNCTION DAMESERVIDO(MIIDINFOPICK NUMBER,MINUMDISP NUMBER) RETURN NUMBER IS
     MIDISP VDINFODISP%ROWTYPE;
    BEGIN
      SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
      RETURN MIDISP.CANTVALIDADADISP;
    END;  
    
    FUNCTION ENBOCAMAT(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MICODMAT IN OUT VARCHAR2) RETURN NUMBER IS
      HAY NUMBER;
     BEGIN
       SELECT CODMAT INTO MICODMAT
        FROM (SELECT CODMAT
         FROM VDCONTE
         WHERE CODUBI=(SELECT CODUBI FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP)
         ORDER BY POSCONTE)
        WHERE ROWNUM=1;
       SELECT NVL(SUM(CANTIDAD),0) INTO HAY FROM VDSTOCK WHERE CODMAT=MICODMAT AND BLOQUEOS='0000000000' AND ROWNUM=1;
       RETURN HAY;
     END;
     
    FUNCTION ENBOCA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER) RETURN NUMBER IS
      MICODMAT VDCONTE.CODMAT%TYPE;
     BEGIN
       RETURN ENBOCAMAT(MIIDINFOPICK,MINUMDISP,MICODMAT);
     END;

  PROCEDURE VALORZONA(MICODZONA NUMBER)  IS
    MIZONA VDZONAS%ROWTYPE;
    MIBZO VDBULTOZONA%ROWTYPE;
    ENCURSO NUMBER;
    BEGIN
      SELECT * INTO MIZONA FROM VDZONAS WHERE CODZONA=MICODZONA;
      IF MIZONA.IDMENU IS NOT NULL AND MIZONA.TEXTOMENU IS NOT NULL THEN
         VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP, NVL(VD.PIECE(MIZONA.TEXTOMENU, '|', 2),'APAGADO'),VD.PIECE(MIZONA.TEXTOMENU,'|',1));
       ELSE
         CASE MIZONA.STATUS
              WHEN VDST.FZONCERRADA THEN VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP, 'APAGADO','@CERRADA,3,1,2@ZONA '||MICODZONA,',3,1,1');
              WHEN VDST.FZONABIERTA THEN VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP, 'APAGADO','@U.',MIZONA.CODOPE,',3,1,2@ZONA '||MICODZONA,',3,1,1');
              WHEN VDST.FZONVACIANDO THEN VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP, MIZONA.COLORZONA,'@VACIANDO ',MIZONA.CODOPE,',3,1,2@ZONA '||MICODZONA,',3,1,1');
              WHEN VDST.FZONCONFBULTO THEN 
                       DECLARE
                        MIBULTO VDBULTOCAB%ROWTYPE;
                       BEGIN
                         SELECT * INTO MIBZO FROM VDBULTOZONA WHERE CODZONA=MICODZONA AND STATUS=VDST.FBZOPDTECONF AND ROWNUM=1;
                         SELECT * INTO MIBULTO FROM VDBULTOCAB WHERE CODBULTO=MIBZO.CODBULTO;
                         VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP,MIZONA.COLORZONA,'@'||MIBULTO.CODDIV||'-'|| SUBSTR(MIBULTO.CODPED,GREATEST(-6,-LENGTH(MIBULTO.CODPED)))||' BULTO: '||MIBULTO.NBULTO||',3,1,2@CONFIRME    BULTO,3,1,1');
                         EXCEPTION WHEN NO_DATA_FOUND THEN 
                              VDECOMENU.CAMBIASTATUSZONA(MICODZONA,VDST.FZONABIERTA);  
                            --  VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP,'BLANCO', '@EN CURSO',ENCURSO,'BULTOS,3,1,2@ZONA '||MICODZONA,',3,1,1');
                             VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP,'VERDE', '@'||MIBULTO.CODDIV||'-'|| SUBSTR(MIBULTO.CODPED,GREATEST(-6,-LENGTH(MIBULTO.CODPED)))||' BULTO: '||MIBULTO.NBULTO||',3,1,2@PREPARANDO3,1,1'||'@PEND'||ENCURSO||',3,1,12');
                       END;               
              WHEN VDST.FZONCONBULTO THEN 
                       DECLARE
                        MIBULTO VDBULTOCAB%ROWTYPE;
                       BEGIN
                         SELECT COUNT(*) INTO ENCURSO FROM VDBULTOZONA WHERE CODZONA=MICODZONA;  
                         SELECT * INTO MIBULTO FROM VDBULTOCAB WHERE CODBULTO IN (SELECT CODBULTO FROM VDBULTOZONA WHERE CODZONA=MICODZONA AND STATUS=VDST.FBZOENCURSO);
                         VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP,'VERDE', '@'||MIBULTO.CODDIV||'-'|| SUBSTR(MIBULTO.CODPED,GREATEST(-6,-LENGTH(MIBULTO.CODPED)))||',3,1,1@BULTO: '||MIBULTO.NBULTO||',3,1,2@PEND '||ENCURSO||',3,12,1');                       
                       END; 
              WHEN VDST.FZONFINBULTO THEN
                        DECLARE
                        MIBULTO VDBULTOCAB%ROWTYPE;
                       BEGIN
                         SELECT COUNT(*) INTO ENCURSO FROM VDBULTOZONA WHERE CODZONA=MICODZONA;  
                         SELECT * INTO MIBULTO FROM VDBULTOCAB WHERE CODBULTO IN (SELECT CODBULTO FROM VDBULTOZONA WHERE CODZONA=MICODZONA AND STATUS=VDST.FBZOENCURSO);
                         VDECOPKG.MUESTRADISP(MIZONA.IDINFOPICK,MIZONA.NUMDISP,'VERDE', '@'||MIBULTO.CODDIV||'-'|| SUBSTR(MIBULTO.CODPED,GREATEST(-6,-LENGTH(MIBULTO.CODPED)))||' BULTO: '||MIBULTO.NBULTO||',3,1,2@TERMINADO,3,1,1'||'@PEND '||ENCURSO||',3,1,2');                       
                       END; 
                                        
              ELSE NULL;    
          END CASE;
       END IF;
    END;
    
  PROCEDURE VALORDISPLAY(MIIDINFOPICK NUMBER,MINUMDISP NUMBER) IS
      MICOLOROPE VARCHAR2(20);
      MIDISP VDINFODISP%ROWTYPE;
      VALOR VDINFOHARDDISP.TEXTO%TYPE;
      MILUCES VDINFOHARDDISP.LUCES%TYPE;
      MICODMAT VDCONTE.CODMAT%TYPE;
      MICODMOV NUMBER;
      STZONA NUMBER;
      HAY NUMBER;
      RET NUMBER;
      MICANDADO VDUBICA.SWTCANDADO%TYPE;
    BEGIN
        SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
        SELECT STATUS INTO STZONA FROM VDZONAS WHERE CODZONA=MIDISP.CODZONA;
        BEGIN 
          SELECT SWTCANDADO INTO MICANDADO FROM VDUBICA WHERE CODUBI=MIDISP.CODUBI;
          EXCEPTION WHEN NO_DATA_FOUND THEN MICANDADO:='N';
        END;
        IF STZONA=VDST.FZONCERRADA THEN
           UPDATE VDINFODISP SET STATUS=VDST.FIDIAPAGADO WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
           VALOR:='';
           MILUCES:='APAGADO';
         ELSE
          VDLOG.PONDEBUG('VALORDISPLAY','DISPLAY',MINUMDISP,'ESTADO',MIDISP.STATUS);
           CASE MIDISP.STATUS
                  WHEN VDST.FIDIFINPICKING THEN VALOR:='OK';
                  WHEN VDST.FIDIVACIADO THEN 
                       HAY:=ENBOCAMAT(MIIDINFOPICK, MINUMDISP, MICODMAT);
                       IF HAY>0 THEN
                          VALOR:='@LEA,3,1,1@'||MICODMAT||',3,1,2';
                        ELSE
                          UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
                       END IF;
                       MILUCES:=DAMECOLORZONA(MIDISP.CODZONA)||';3';                      
                  WHEN VDST.FIDICONFCIERRE THEN VALOR:='@CIERRE,3,1,1@PUERTA,3,1,2';
                                                MILUCES:=DAMECOLORMOV(MIDISP.CODMOV);
                  WHEN VDST.FIDIFINBULTO THEN VALOR:='FIN';
                                              MILUCES:=DAMECOLORMOV(MIDISP.CODMOV);
                  WHEN VDST.FIDICONFVACIA THEN VALOR:='@VACIA,3,1,1@'||MIDISP.CODMAT||',3,1,2';
                                              MILUCES:=DAMECOLORMOV(MIDISP.CODMOV);
                  WHEN VDST.FIDICONFSIG THEN  HAY:=ENBOCAMAT(MIIDINFOPICK,MINUMDISP,MICODMAT);
                                              IF HAY=0 THEN
                                                 CONTINUAPICKING(MIIDINFOPICK,MINUMDISP,MIDISP.CODMOV);
                                               ELSE
                                                 UPDATE VDINFODISP SET CODMAT=MICODMAT WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP AND NVL(CODMAT,' ')!=MICODMAT;
                                                 MIDISP.CODMAT:=MICODMAT;
                                                 VALOR:='@SIGUIENTE,3,1,1@'||MIDISP.CODMAT||',3,1,2';
                                              END IF;
                                              MILUCES:=DAMECOLORMOV(MIDISP.CODMOV);                                              
                  WHEN VDST.FIDISIRVEMENOS THEN
                    DECLARE
                      PIDEN NUMBER;
                      HAY NUMBER;
                      SIRVE NUMBER;
                      MICODCONCE VDMOVIM.CODCONCE%TYPE;
                    BEGIN 
                      SELECT CANTIDAD INTO PIDEN FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV;
                      SELECT CANTIDAD INTO HAY FROM VDSTOCK WHERE CODMAT IN (SELECT CODMATORI FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV);
                      SIRVE:=MIDISP.CANTVALIDADADISP;
                      MICODCONCE:='REG-';
                      VALOR:='@'||MICODCONCE||',3,6,1@'||(HAY-SIRVE)||',3,6,2@PIDEN '||PIDEN||',1,1,1@SIRVE '||SIRVE||',1,1,2@HAY '||HAY||',1,1,3@'||MIDISP.CODUBI||',1,1,4';
                      MILUCES:=DAMECOLORMOV(MIDISP.CODMOV)||';3';
                      MICANDADO:='N';
                    END;
                  WHEN VDST.FIDIPASOX0 THEN
                    DECLARE
                      PIDEN NUMBER;
                      SIRVE NUMBER;
                      MICODCONCE VDMOVIM.CODCONCE%TYPE;
                    BEGIN 
                      SELECT CANTIDAD INTO PIDEN FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV;
                      SELECT CANTIDAD INTO HAY FROM VDSTOCK WHERE CODMAT IN (SELECT CODMATORI FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV);
                      SIRVE:=MIDISP.CANTVALIDADADISP;
                      MICODCONCE:='QUEDAN';
                      VALOR:='@'||LPAD(MIDISP.QUEDAN,4)||',3,6,2@'||MICODCONCE||',3,5,1@PIDEN '||PIDEN||',1,1,1@SIRVE '||SIRVE||',1,1,2@HAY '||HAY||',1,1,3@'||MIDISP.CODUBI||',1,1,4';
                      MICANDADO:='N';
                    END;
                  WHEN VDST.FIDIPICKING THEN
                              MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
                              VDLOG.PONDEBUG('VALORDISPLAY','DISPLAY',MIIDINFOPICK,MINUMDISP,'MOVIMIENTO',MICODMOV);
                              IF MICODMOV!=0 THEN
                                  MICOLOROPE:=DAMECOLORMOV(MICODMOV);
                                  IF MIDISP.STATUS<VDST.FIDIPICKING OR MICODMOV!=MIDISP.CODMOV THEN
                                      RET:=VDMOV.CONGELA(MICODMOV);
                                      IF RET=0 THEN 
                                         SELECT CANTIDAD INTO VALOR FROM VDMOVIM WHERE CODMOV=MICODMOV;
                                         UPDATE VDINFODISP SET STATUS=VDST.FIDIPICKING,
                                                               CODMOV=MICODMOV,
                                                               CANTPEDIDADISP=VALOR,
                                                               CANTVALIDADADISP=VALOR
                                            WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
                                         MIDISP.CANTVALIDADADISP:=VALOR;
                                         MIDISP.CANTPEDIDADISP:=VALOR;
                                       ELSE MIDISP.CANTPEDIDADISP:=0;
                                      END IF;
                                   END IF;
                                  IF MIDISP.CANTPEDIDADISP>0 THEN 
                                     HAY:=ENBOCAMAT(MIIDINFOPICK,MINUMDISP,MICODMAT);
                                   --  VDECOPKG.ANADEDISP(VALOR,LPAD(MIDISP.CANTVALIDADADISP,5),2,1,1,'S');
                                   --  VDECOPKG.ANADEDISP(VALOR,'PI. '||MIDISP.CANTPEDIDADISP,1,1,1);
                                     VALOR:='@'||LPAD(MIDISP.CANTVALIDADADISP,5)||',2,1,1@PI. '||MIDISP.CANTPEDIDADISP||',1,1,1@HAY '||HAY||',1,1,2@CUB '||MICODMAT||',1,1,3@'||MIDISP.CODUBI||',1,1,4';
                                     MICANDADO:='N';
                                   ELSE
                                     VALOR:='';
                                  END IF;                                   
                                ELSE
                                  VALOR:='';
                                  MILUCES:='APAGADO';
                                  UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE,CODMOV=0,CANTPEDIDADISP=0,CANTVALIDADADISP=0 
                                     WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP AND STATUS!=VDST.FIDILIBRE;
                               END IF;
                  ELSE IF STZONA= VDST.FZONCERRADA THEN
                                  UPDATE VDINFODISP SET STATUS=VDST.FIDIAPAGADO WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
                                  VALOR:='';
                                  MILUCES:='APAGADO';
                          END IF;
           END CASE;
        END IF;
        IF VALOR IS NOT NULL AND MILUCES IS NULL THEN
            MILUCES:=MICOLOROPE;--DAMECOLORDISP(MIIDINFOPICK,MINUMDISP);
            IF VALOR='FIN' THEN MILUCES:=VD.PIECE(MILUCES,';',1)||';3';
               END IF;
           ELSIF MILUCES IS NULL THEN MILUCES:='0,0,0,0,0';
         END IF;
        IF MICANDADO='N' THEN 
           MILUCES:=VD.PIECE(MILUCES,';',1)||';'||(CASE WHEN VD.NUMPIECES(MILUCES,';')=1 THEN '1' ELSE VD.PIECE(MILUCES,';',2)||';0' END);
         END IF;
        VDECOPKG.MUESTRADISP(MIIDINFOPICK,MINUMDISP,MILUCES,VALOR);
     END;
     
     
    PROCEDURE REFRESCAZONA(MICODZONA VDZONAS.CODZONA%TYPE) IS
      CURSOR C1 IS SELECT * FROM VDINFODISP WHERE CODZONA=MICODZONA AND
                                       (IDINFOPICK,NUMDISP) NOT IN (SELECT IDINFOPICK,NUMDISP FROM VDZONAS WHERE CODZONA=MICODZONA) AND
                                        (IDINFOPICK,NUMDISP) NOT IN (SELECT IDINFOPICKSEC,NUMDISPSEC FROM VDZONAS WHERE CODZONA=MICODZONA) ;
     BEGIN
      VALORZONA( MICODZONA);                   
       FOR I IN C1 LOOP
            VALORDISPLAY(I.IDINFOPICK,I.NUMDISP);
        END LOOP;
     END;
    
     PROCEDURE METEENZONA(MICODZONA NUMBER,MICODBULTO VARCHAR2) IS
      CURSOR C1 IS   SELECT MOV.CODMOV,IDI.IDINFOPICK,IDI.NUMDISP
           FROM VDMOVIM MOV ,VDBULTOLIN BUL,VDBULTOCAB BUC,VDINFODISP IDI
           WHERE BUC.CODBULTO=MICODBULTO AND MOV.CODMOV=BUL.CODMOV AND
                 BUL.CODBULTO=BUC.CODBULTO AND MOV.CODUBIORI=IDI.CODUBI AND
                 IDI.CODZONA=MICODZONA AND MOV.STATUS=VDST.FMOVPDTERECOGE;
      RET NUMBER;
      MICOLOROPE VDBULTOZONA.COLOROPE%TYPE;
      ERROR VARCHAR2(1000);
     BEGIN
        PONUSUARIO(MICODZONA);
        MICOLOROPE:=VDECOPKGUNI.DAMECOLOR(VDUSER.GETUSER, MICODZONA);
        IF MICOLOROPE IS NULL THEN
           VDECOPKG.PONMENSAJEZONA(MICODZONA,'NO HAY COLORES');
           RETURN;
         END IF;
        VDECOMENU.CAMBIASTATUSZONA(MICODZONA,VDST.FZONCONFBULTO);
        DELETE VDBULTOZONA WHERE CODBULTO=MICODBULTO AND CODZONA!=CODZONA;
        INSERT INTO VDBULTOZONA ( SEQBULTO, CODZONA, CODBULTO, CODOPE, COLOROPE, STATUS, VDEXTRA, CODOPEMODIF, FECMODIF,
                                                     HORAMODIF, CODCOMEN)
               SELECT VDSECCODBULTO.NEXTVAL,MICODZONA,MICODBULTO,VDUSER.GETUSER,MICOLOROPE,VDST.FBZOPDTECONF,'',VDUSER.GETUSER,VD.FECHASYS,VD.HORASYS,0
                FROM DUAL
                WHERE NOT EXISTS (SELECT CODBULTO FROM VDBULTOZONA WHERE CODBULTO=MICODBULTO AND CODZONA=MICODZONA);
        IF SQL%ROWCOUNT=0 THEN UPDATE VDBULTOZONA SET STATUS=VDST.FBZOPDTECONF WHERE CODBULTO=MICODBULTO AND CODZONA=MICODZONA;
         END IF;
        REFRESCAZONA(MICODZONA);
     END;
     
     PROCEDURE SACADEZONAS(MICODBULTO VARCHAR2) IS
       CURSOR CSELBULTOZONA IS SELECT * FROM VDBULTOZONA WHERE CODBULTO=MICODBULTO;
       HAY NUMBER;
       STZONA NUMBER;
      BEGIN
        FOR BUL IN CSELBULTOZONA LOOP
            DELETE VDBULTOZONA WHERE CODBULTO=BUL.CODBULTO AND CODZONA=BUL.CODZONA;
            VDLOG.PONMENSAJE('SACADEZONAS','BULTO',BUL.CODBULTO,'SALE DE ZONA',BUL.CODZONA,'STATUS',BUL.STATUS);
            IF BUL.STATUS>=VDST.FBZOPDTECONF THEN
               SELECT STATUS INTO STZONA FROM VDZONAS WHERE CODZONA=BUL.CODZONA;
               IF STZONA IN (VDST.FZONCONBULTO,VDST.FZONCONFBULTO) THEN 
                  VDECOMENU.CAMBIASTATUSZONA(BUL.CODZONA,VDST.FZONABIERTA);
                END IF;
               SELECT COUNT(*) INTO HAY FROM VDBULTOZONA WHERE CODZONA=BUL.CODZONA;
               IF HAY=0 THEN
                  VDECOUNI.REFRESCAZONA(BUL.CODZONA);
                END IF;
             END IF;
         END LOOP;
      END;
     
     FUNCTION ENCIENDEUNO(MICODBULTO VARCHAR2,MIIDINFOPICK NUMBER, MINUMDISP NUMBER) RETURN NUMBER IS
       MICODMOV NUMBER;
       RET NUMBER;
      BEGIN
        MICODMOV:=DAMECODMOV(MIIDINFOPICK, MINUMDISP);
        IF DAMEBULTOMOV(MICODMOV)!=MICODBULTO THEN RETURN 0;
         END IF;
        VDECOPKGUNI.AGRUPAMOVYBUL(MICODMOV);
        MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
        IF MICODMOV=0 THEN RETURN 0;
         END IF;
        RET:=VDMOV.CONGELA(MICODMOV, 'S');
        UPDATE VDINFODISP SET STATUS=VDST.FIDIPICKING,CODMOV=0 WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
        VALORDISPLAY(MIIDINFOPICK, MINUMDISP);
        RETURN 1;
      END; 
    
     FUNCTION ENCIENDEDISPLAYS(MICODZONA NUMBER,MICODBULTO VARCHAR2) RETURN NUMBER IS
      DISPLAYS NUMBER;
      CURSOR C1 IS   SELECT DISTINCT IDI.IDINFOPICK,IDI.NUMDISP,UBI.ORDENMOVIM
           FROM VDMOVIM MOV ,VDBULTOLIN BUL,VDBULTOCAB BUC,VDINFODISP IDI,VDUBICA UBI
           WHERE BUC.CODBULTO=MICODBULTO AND MOV.CODMOV=BUL.CODMOV AND
                 BUL.CODBULTO=BUC.CODBULTO AND MOV.CODUBIORI=IDI.CODUBI AND
                 IDI.CODZONA=MICODZONA AND MOV.STATUS=VDST.FMOVPDTERECOGE AND UBI.CODUBI=MOV.CODUBIORI
           ORDER BY UBI.ORDENMOVIM;
      RET NUMBER;
     BEGIN
        PONUSUARIO(MICODZONA);
        DISPLAYS:=0;
        FOR I IN C1 LOOP
            VDLOG.PONMENSAJE('ENCIENDEDISPLAYS','ENCENDIENDO DISPLAY',I.IDINFOPICK,I.NUMDISP);
            RET:=ENCIENDEUNO(MICODBULTO,I.IDINFOPICK,I.NUMDISP);
            DISPLAYS:=DISPLAYS+RET;
            EXIT;
        END LOOP;
        IF DISPLAYS=0 THEN
           VDLOG.PONMENSAJE('ENCIENDEDISPLAYS','SIN DISPLAYS PARA BULTO',MICODBULTO,'EN ZONA',MICODZONA);
           VDECOMENU.CAMBIASTATUSZONA(MICODZONA, VDST.FZONFINBULTO);
         ELSE
           UPDATE VDZONAS SET IDMENU='NCONBULTO' WHERE CODZONA=MICODZONA;
        END IF;
        VALORZONA(MICODZONA);
        RETURN DISPLAYS;
     END;
     
      
   FUNCTION DISCRIMINANTE(MIIDINFOPICK NUMBER,MIDISP NUMBER,MITECLA NUMBER) RETURN VARCHAR2 IS
      MICODZONA VDINFODISP.CODZONA%TYPE;
      MISTDISP VDSTATUS.DABSTATUS%TYPE;
      MISTZONA VDSTATUS.DABSTATUS%TYPE;
      ESCONTROLADOR NUMBER;
      TRATADA NUMBER;
   BEGIN
       SELECT ZON.CODZONA,ST.DABSTATUS,STD.DABSTATUS,(CASE WHEN ZON.NUMDISP=MIDISP AND ZON.IDINFOPICK=MIIDINFOPICK THEN 1 ELSE 0 END)  
         INTO MICODZONA,MISTZONA,MISTDISP,ESCONTROLADOR
         FROM VDINFODISP DISP,VDZONAS ZON,VDSTATUS ST,VDSTATUS STD
          WHERE DISP.IDINFOPICK=MIIDINFOPICK AND DISP.NUMDISP=MIDISP AND ZON.CODZONA=DISP.CODZONA  AND
                      ST.STATUS=ZON.STATUS AND ST.TIPOSTATUS='ZON' AND STD.STATUS=DISP.STATUS AND STD.TIPOSTATUS='IDI';
      IF ESCONTROLADOR>0 THEN 
         TRATADA:=VDECOMENU.TRATATECLAZONA(MIIDINFOPICK,MIDISP,MITECLA);
         IF TRATADA=-1 THEN
            VALORZONA(MICODZONA);
            RETURN NULL;
          END IF;
       ELSE 
         TRATADA:=VDECOMENU.TRATATECLADISP(MIIDINFOPICK,MIDISP,MITECLA);
      END IF;
      IF TRATADA=-1 THEN 
         RETURN NULL;
       END IF;
      RETURN MIIDINFOPICK||'#'||MIDISP||'#'||MICODZONA||'#'||MISTDISP||'#'||MISTZONA||'#'||VDECOPKG.DAMENOMBRETECLA(MITECLA)||'#'||ESCONTROLADOR;
   END;
   
   PROCEDURE TRATATICK(MIIDINFOGEST NUMBER) IS
      CURSOR CTICKZONAS IS SELECT CODZONA FROM VDZONAS WHERE IDINFOGEST=MIIDINFOGEST AND  NEXTTICK>0 AND NEXTTICK<VD.FECHASEC;
      CURSOR CTICKDISP IS SELECT IDI.IDINFOPICK,IDI.NUMDISP
                     FROM VDINFODISP IDI,VDINFOHARDDISP IDH
                     WHERE IDH.IDINFOGEST+0=MIIDINFOGEST AND  IDI.NEXTTICK>0 AND IDI.NEXTTICK<VD.FECHASEC AND
                           IDI.IDINFOPICK=IDH.IDINFOPICK AND IDI.NUMDISP=IDH.NUMDISP;
      CURSOR CVACIA IS SELECT ZON.CODZONA,MOV.CODMOV,UBI.CODUBI,CNT.POSCONTE,CNT.CODMAT
                          FROM VDZONAS ZON,VDMOVIM MOV,VDUBICA UBI,VDCONTE CNT 
                          WHERE IDINFOGEST+0=MIIDINFOGEST AND ZON.STATUS=VDST.FZONABIERTA AND
                                MOV.STATUS=VDST.FMOVPDTERECOGE AND MOV.CODUBIORI=UBI.CODUBI AND UBI.CODAREA='PUL' AND
                                UBI.CODZONA=ZON.CODZONA AND CODUBIDEST='CINTA' AND CODMATORI=CODMATDEST AND
                                CNT.CODMAT=MOV.CODMATORI
                          ORDER BY UBI.ORDENSALIDA,CNT.POSCONTE;
      CURSOR CCONCOLA IS SELECT CODZONA 
                          FROM VDZONAS 
                          WHERE IDINFOGEST+0=MIIDINFOGEST AND STATUS=VDST.FZONABIERTA AND
                                EXISTS (SELECT CODBULTO FROM VDBULTOZONA WHERE CODZONA=VDZONAS.CODZONA AND STATUS=VDST.FBZOENCOLA);
      MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
     BEGIN
        FOR I IN CTICKZONAS LOOP
              UPDATE VDZONAS SET NEXTTICK=0 WHERE CODZONA=I.CODZONA;
              VDLOG.PONMENSAJE('TRATATICK','MANDANDO TICK A ZONA',I.CODZONA);
              VALORZONA(I.CODZONA);
         END LOOP;
        FOR I IN CTICKDISP LOOP
              UPDATE VDINFODISP SET NEXTTICK=0 WHERE IDINFOPICK=I.IDINFOPICK AND NUMDISP=I.NUMDISP;
              VDLOG.PONMENSAJE('TRATATICK','MANDANDO TICK A DISPLAY',I.IDINFOPICK,I.NUMDISP);
              VALORDISPLAY(I.IDINFOPICK,I.NUMDISP);
         END LOOP;
        FOR I IN CVACIA LOOP
          DECLARE
            MICODMAT VDCONTE.CODMAT%TYPE;
            MIIDINFOPICK NUMBER;
            MINUMDISP NUMBER;
          BEGIN
            SELECT CODMAT INTO MICODMAT
              FROM VDCONTE 
              WHERE CODUBI=I.CODUBI AND POSCONTE<I.POSCONTE AND ROWNUM=1;
            CONTINUE;
           EXCEPTION WHEN NO_DATA_FOUND THEN 
             VDLOG.PONMENSAJE('TRATATICK','VACIANDO UBICACION',I.CODUBI,'EN ZONA',I.CODZONA);
             VDECOMENU.CAMBIASTATUSZONA(I.CODZONA, VDST.FZONVACIANDO);
             UPDATE VDINFODISP SET STATUS=VDST.FIDIVACIADO,CODMAT=I.CODMAT WHERE CODUBI=I.CODUBI; 
             SELECT IDINFOPICK,NUMDISP INTO MIIDINFOPICK,MINUMDISP FROM VDINFODISP WHERE CODUBI=I.CODUBI;
             VALORDISPLAY(MIIDINFOPICK, MINUMDISP);
             EXIT;
          END;
         END LOOP;
        FOR I IN CCONCOLA LOOP
            BEGIN
              SELECT CODBULTO INTO MICODBULTO
                 FROM (SELECT CODBULTO FROM VDBULTOZONA WHERE STATUS=VDST.FBZOENCOLA AND CODZONA=I.CODZONA ORDER BY SEQBULTO) 
                 WHERE ROWNUM=1;
              EXCEPTION WHEN NO_DATA_FOUND THEN CONTINUE;
            END;
            BEGIN
              METEENZONA(I.CODZONA,MICODBULTO);
              VALORZONA(I.CODZONA);
              EXCEPTION WHEN NO_DATA_FOUND THEN
                  VDLOG.PONMENSAJE('TRATASCANINFO','BULTO',MICODBULTO,'VACIO',I.CODZONA);
                  VDECOMENU.CAMBIASTATUSZONA(I.CODZONA,VDST.FZONSOLRETIRAD);
            END;
         END LOOP;
         EXCEPTION WHEN OTHERS THEN VDLOG.PONERROR('TRATATICK','ERROR AL PROCESAR TICK');
     END;
  
-- mira si se ha finalizado el bulto de expediciones
    FUNCTION ESFINBULTO(MICODBULTO VDBULTOCAB.CODBULTO%TYPE,MICODZONA NUMBER) RETURN NUMBER IS
      RET NUMBER:=0;
    BEGIN
         SELECT SUM(1) INTO RET 
           FROM VDBULTOLIN BUL,VDMOVIM MOV,VDUBICA UBIO
           WHERE CODBULTO=MICODBULTO AND BUL.STATUS=VDST.FBULASERVIR AND MOV.CODMOV=BUL.CODMOV AND MOV.STATUS BETWEEN VDST.FMOVPDTERECOGE AND VDST.FMOVPRESENTADO AND
                 UBIO.CODUBI=MOV.CODUBIORI AND UBIO.CODZONA=MICODZONA;
         IF RET>0 THEN RETURN 0;
          ELSE RETURN 1;
         END IF;
    END ESFINBULTO;
        
    PROCEDURE REVISAFINPICKING(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MICODMOV NUMBER) IS
          MICODZONA VDZONAS.CODZONA%TYPE;
          MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
          QUEDAN NUMBER;
      BEGIN
         MICODBULTO:=DAMEBULTOMOV(MICODMOV);
         SELECT CODZONA INTO MICODZONA FROM VDINFODISP WHERE  IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
         IF ESFINBULTO(MICODBULTO,MICODZONA)=1 THEN
            UPDATE VDINFODISP SET STATUS=VDST.FIDIFINBULTO WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP AND  STATUS!=VDST.FIDIFINBULTO;
          ELSE        
            UPDATE VDINFODISP SET STATUS=VDST.FIDIAPAGADO WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP AND STATUS NOT IN (VDST.FIDIAPAGADO,VDST.FIDIASOCIACAJA);
            QUEDAN:=ENCIENDEDISPLAYS(MICODZONA, MICODBULTO);
          END IF;
         UPDATE VDINFODISP SET VDEXTRA='' WHERE  IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP AND VDEXTRA IS NOT NULl;
         VALORZONA(MICODZONA);
         VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
      END;

  PROCEDURE CONTINUAPICKING(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MICODMOV NUMBER) IS
    NUEVOMOV NUMBER;
    MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
    ENCIENDE NUMBER;
    MICANDADO VDUBICA.SWTCANDADO%TYPE;
   BEGIN
     NUEVOMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
     IF NUEVOMOV!=0 THEN  
        MICODBULTO:=DAMEBULTOMOV(NUEVOMOV);      
        ENCIENDE:=ENCIENDEUNO(MICODBULTO, MIIDINFOPICK, MINUMDISP);
      END IF;
     BEGIN
       SELECT SWTCANDADO INTO MICANDADO FROM VDUBICA WHERE CODUBI=(SELECT CODUBI FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP);
       EXCEPTION WHEN NO_DATA_FOUND THEN MICANDADO:='N';
      END;
     IF MICANDADO='S' THEN
        UPDATE VDINFODISP SET STATUS=VDST.FIDICONFCIERRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
        VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
      ELSE
        REVISAFINPICKING(MIIDINFOPICK, MINUMDISP,MICODMOV);
     END IF;
   END;
          
    
  FUNCTION DAMETIPOSCAN(MITEXTO VARCHAR2) RETURN NUMBER IS
     MICODOPE VDUSUARIO.CODOPE%TYPE;
     MICODMAT VARCHAR2(100);
    BEGIN
       SELECT CODOPE INTO MICODOPE FROM VDUSUARIO WHERE CODOPE=MITEXTO;
       RETURN 0;
       EXCEPTION WHEN NO_DATA_FOUND THEN BEGIN
          IF MITEXTO='NO READ' THEN RETURN 1;
           END IF;
          SELECT CODBULTO INTO MICODMAT FROM VDBULTOCAB WHERE CODBULTO=LTRIM(MITEXTO,'00') AND ROWNUM=1;
          RETURN 1;
          EXCEPTION WHEN NO_DATA_FOUND THEN BEGIN
             MICODMAT:=VDART.DAMEART(MITEXTO);
             SELECT MICODMAT INTO MICODMAT FROM VDARTIC WHERE CODART=MICODMAT;
             RETURN 2;
             EXCEPTION WHEN NO_DATA_FOUND THEN
                IF LENGTH(MITEXTO)=VD.GETPROP('LONCUBETA') THEN RETURN 4;
                 END IF;
                 RETURN -1;
            END;
        END;
    END;
     
    PROCEDURE TRATASCANINFO(MIINFOGEST NUMBER)  IS
      TEXTO VDSCANLECT.TEXTO%TYPE;
      MIRED NUMBER;
      MISCANNER NUMBER;
      TIPOSCAN NUMBER;
      MIZONA VDZONAS%ROWTYPE;
      RET NUMBER;
     BEGIN
        TEXTO:=VDSCANNER.DAMELECTURAINFO(MIINFOGEST,MIRED,MISCANNER);
        COMMIT;
        IF TEXTO IS NULL THEN RETURN; END IF;
        MIZONA.CODZONA:=VDECOPKG.DAMEZONALECT(MIRED,MISCANNER);
        SELECT * INTO MIZONA FROM VDZONAS WHERE CODZONA=MIZONA.CODZONA;
        IF TEXTO='ANULA' THEN
           VDLOG.PONMENSAJE('TRATASCANINFO','ANULANDO ZONA',MIZONA.CODZONA);
           DELETE VDBULTOZONA WHERE CODZONA=MIZONA.CODZONA;
           IF MIZONA.STATUS!=VDST.FZONCERRADA THEN
              VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA,VDST.FZONABIERTA);
            END IF;
           UPDATE VDINFODISP SET STATUS=50 WHERE CODZONA=MIZONA.CODZONA;
           REFRESCAZONA(MIZONA.CODZONA);
           RETURN;
         END IF;
        TIPOSCAN:=DAMETIPOSCAN(TEXTO);
        VDLOG.PONMENSAJE('TRATASCANINFO','RECIBIDO MENSAJE DE SCANNER',MISCANNER,'TEXTO',TEXTO,'TIPO',TIPOSCAN,'ZONA',MIZONA.CODZONA);
        CASE MIZONA.STATUS
                          WHEN VDST.FZONCERRADA THEN 
                              IF TIPOSCAN=0  THEN
                                 VDLOG.PONMENSAJE('TRATASCANINFO','ABIERTA ZONA',MIZONA.CODZONA);
                                 VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA, VDST.FZONABIERTA);
                                 UPDATE VDZONAS SET CODOPE=TEXTO
                                   WHERE CODZONA=MIZONA.CODZONA;
                                 REFRESCAZONA(MIZONA.CODZONA);
                               ELSE
                                 VDLOG.PONMENSAJE('TRATASCANINFO','MENSAJE NO DE OPERARIO EN ZONA',MIZONA.CODZONA,'CERRADA');
                               END IF;
                          WHEN VDST.FZONABIERTA THEN 
                              CASE TIPOSCAN
                                 WHEN 0 THEN
                                    VDLOG.PONMENSAJE('TRATASCANINFO','CERRADA ZONA',MIZONA.CODZONA);
                                    VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA, VDST.FZONCERRADA);
                                    UPDATE VDBULTOZONA SET STATUS=VDST.FBZOENCOLA WHERE STATUS IN (VDST.FBZOPDTECONF,VDST.FBZOENCURSO) AND CODZONA=MIZONA.CODZONA;
                                    REFRESCAZONA(MIZONA.CODZONA);
                                 WHEN 1 THEN
                                    VDLOG.PONMENSAJE('TRATASCANINFO','ENCENDIENDO DISPLAYS EN ZONA',MIZONA.CODZONA,'PARA BULTO',TEXTO);
                                    BEGIN
                                      METEENZONA(MIZONA.CODZONA,TEXTO);
                                     EXCEPTION WHEN NO_DATA_FOUND THEN
                                      VDLOG.PONMENSAJE('TRATASCANINFO','BULTO',TEXTO,'VACIO',MIZONA.CODZONA);
                                      VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA,VDST.FZONSOLRETIRAD);
                                    END;
                                    VALORZONA(MIZONA.CODZONA);
                                  ELSE NULL;
                                 END CASE;
                         WHEN VDST.FZONCONFBULTO THEN 
                              CASE TIPOSCAN
                                WHEN 0 THEN
                                    VDLOG.PONMENSAJE('TRATASCANINFO','CERRADA ZONA',MIZONA.CODZONA);
                                    VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA, VDST.FZONCERRADA);
                                    UPDATE VDBULTOZONA SET STATUS=VDST.FBZOENCOLA WHERE STATUS IN (VDST.FBZOPDTECONF,VDST.FBZOENCURSO) AND CODZONA=MIZONA.CODZONA;
                                    REFRESCAZONA(MIZONA.CODZONA);
                                ELSE NULL;
                               END CASE;
                         WHEN VDST.FZONCONBULTO THEN 
                              CASE TIPOSCAN
                                WHEN 0 THEN
                                    VDLOG.PONMENSAJE('TRATASCANINFO','CERRADA ZONA',MIZONA.CODZONA);
                                    VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA, VDST.FZONCERRADA);
                                    UPDATE VDBULTOZONA SET STATUS=VDST.FBZOENCOLA WHERE STATUS IN (VDST.FBZOPDTECONF,VDST.FBZOENCURSO) AND CODZONA=MIZONA.CODZONA;
                                    REFRESCAZONA(MIZONA.CODZONA);
                                WHEN 1 THEN
                                   DECLARE
                                    PDTEBULTO VDBULTOCAB.CODBULTO%TYPE;
                                   BEGIN
                                     SELECT CODBULTO INTO PDTEBULTO FROM VDBULTOZONA WHERE CODZONA=MIZONA.CODZONA AND STATUS=VDST.FBZOPDTECONF;
                                     VDECOPKG.PONMENSAJEZONA(MIZONA.CODZONA, 'CONFIRME BULTO PRIMERO');
                                     EXCEPTION WHEN NO_DATA_FOUND THEN 
                                       SELECT COUNT(*) INTO PDTEBULTO FROM VDBULTOZONA WHERE CODZONA=MIZONA.CODZONA AND CODOPE=MIZONA.CODOPE AND STATUS>=VDST.FBZOENCOLA;
                                       IF PDTEBULTO>=MIZONA.MAXBULTOSOPER THEN
                                          VDECOPKG.PONMENSAJEZONA(MIZONA.CODZONA, 'DEMASIADOS BULTOS');
                                          RETURN;
                                       END IF;                                        
                                       VDLOG.PONMENSAJE('TRATASCANINFO','ENCENDIENDO DISPLAYS EN ZONA',MIZONA.CODZONA,'PARA BULTO',TEXTO);
                                       BEGIN
                                        METEENZONA(MIZONA.CODZONA,TEXTO);
                                        EXCEPTION WHEN NO_DATA_FOUND THEN
                                         VDLOG.PONMENSAJE('TRATASCANINFO','BULTO',TEXTO,'VACIO',MIZONA.CODZONA);
                                         VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA,VDST.FZONSOLRETIRAD);
                                       END;                                  
                                       VALORZONA(MIZONA.CODZONA);
                                   END;
                                 WHEN 4 THEN
                                    DECLARE
                                      MIDISP VDINFODISP%ROWTYPE;
                                    BEGIN
                                      SELECT * INTO MIDISP 
                                        FROM VDINFODISP 
                                        WHERE CODZONA=MIZONA.CODZONA AND STATUS IN (VDST.FIDICONFVACIA,VDST.FIDICONFSIG) AND ROWNUM=1;
                                      IF MIDISP.STATUS=VDST.FIDICONFSIG THEN
                                        DECLARE
                                          HAY NUMBER;
                                        BEGIN
                                         HAY:=ENBOCAMAT(MIDISP.IDINFOPICK, MIDISP.NUMDISP, MIDISP.CODMAT); 
                                        END;
                                      END IF;
                                      IF SUBSTR(TEXTO,2)=MIDISP.CODMAT THEN
                                         IF MIDISP.STATUS=VDST.FIDICONFVACIA THEN
                                            KNAP.MANDAVACIA(MIDISP.CODMAT); 
                                            VDECOPKG.PONMENSAJEDISPLAY(MIDISP.IDINFOPICK,MIDISP.NUMDISP,'@TAPA A LA,3,1,1@IZQUIERDA,3,1,2');
                                            IF VD.GETPROP('CONFSIGUIENTE')='S' THEN
                                               UPDATE VDINFODISP SET STATUS=VDST.FIDICONFSIG
                                                WHERE IDINFOPICK=MIDISP.IDINFOPICK AND NUMDISP=MIDISP.NUMDISP;
                                               VALORDISPLAY(MIDISP.IDINFOPICK,MIDISP.NUMDISP);
                                             ELSE
                                               CONTINUAPICKING(MIDISP.IDINFOPICK,MIDISP.NUMDISP,MIDISP.CODMOV);
                                            END IF;
                                          ELSE
                                            CONTINUAPICKING(MIDISP.IDINFOPICK,MIDISP.NUMDISP,MIDISP.CODMOV);
                                          END IF;
                                        ELSE
                                          VDLOG.PONMENSAJE('TRATASCANINFO','CUBETA ERRONEA LEIDA',TEXTO,'ESPERADA',MIDISP.CODMAT);
                                          VDECOPKG.PONMENSAJEDISPLAY(MIDISP.IDINFOPICK,MIDISP.NUMDISP,'@CUBETA,3,1,1@ERRONEA,3,1,2');
                                       END IF;
                                     EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
                                    END;
                                 ELSE VDLOG.PONERROR('TRATASCANINFO','LECTURA',TEXTO,'EN ZONA',MIZONA.CODZONA,'INCORRECTO');
                              END CASE;
                         WHEN VDST.FZONVACIANDO THEN
                              CASE TIPOSCAN
                                 WHEN 4 THEN
                                    DECLARE
                                      MIDISP VDINFODISP%ROWTYPE;
                                      MICODMOV NUMBER;
                                      MSJERROR VARCHAR2(1000);
                                      RET NUMBER;
                                    BEGIN
                                      SELECT * INTO MIDISP 
                                        FROM VDINFODISP 
                                        WHERE CODZONA=MIZONA.CODZONA AND STATUS=VDST.FIDIVACIADO AND ROWNUM=1; 
                                      IF SUBSTR(TEXTO,2)=MIDISP.CODMAT THEN 
                                         SELECT CODMOV INTO MICODMOV 
                                          FROM VDMOVIM
                                          WHERE MIDISP.CODUBI=CODUBIORI AND STATUS=VDST.FMOVPDTERECOGE AND CODUBIDEST='CINTA' AND
                                                CODMATORI=CODMATDEST AND CODMATORI=MIDISP.CODMAT;
                                         RET:=VDACTSTOCK.EJECUTAMOV(MICODMOV, MSJERROR);
                                         VDECOPKG.PONMENSAJEDISPLAY(MIDISP.IDINFOPICK,MIDISP.NUMDISP,'@TAPA A LA,3,1,1@IZQUIERDA,3,1,2');
                                         UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIDISP.IDINFOPICK AND NUMDISP=MIDISP.NUMDISP;
                                         VALORDISPLAY(MIDISP.IDINFOPICK,MIDISP.NUMDISP);
                                         VDECOMENU.CAMBIASTATUSZONA(MIZONA.CODZONA,VDST.FZONABIERTA);
                                        ELSE
                                         VDLOG.PONMENSAJE('TRATASCANINFO','CUBETA ERRONEA LEIDA',TEXTO,'ESPERADA',MIDISP.CODMAT);
                                       END IF;
                                     EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
                                    END;
                                  ELSE NULL;
                                END CASE;                                  
                         ELSE NULL;
            END CASE;
        COMMIT;
     END;
     
-- Ejecuta el picking de una cantidad determinada en un display
  PROCEDURE EJECUTAMOV(MIIDINFOPICK VDINFODISP.IDINFOPICK%TYPE, MINUMDISP VDINFODISP.NUMDISP%TYPE, RET IN OUT NUMBER) IS
   CURSOR CMOVPICK IS SELECT DISTINCT MOV.CODMOV, MOV.CODCOMEN, MOV.CODART, MOV.CODLOT, BUL.CODBULTO, BUL.SEQLINEA, MOV.CANTIDAD,
                                BUC.CODPED, BUC.SEQPED, BUC.ANOPED, BUC.CODDIV
                         FROM  VDBULTOLIN BUL,VDMOVIM MOV,VDBULTOCAB BUC
                         WHERE  BUL.CODMOV=MOV.CODMOV AND 
                                BUC.CODBULTO=BUL.CODBULTO AND BUL.STATUS=VDST.FBULASERVIR AND 
                                MOV.CODMOV=DAMECODMOV(MIIDINFOPICK,MINUMDISP)
                          ORDER BY BUL.SEQLINEA;
    MIINFODISP VDINFODISP%ROWTYPE;
    ART VDARTIC%ROWTYPE;
    MOV VDMOVIM%ROWTYPE;
    PEC VDPEDIDOCAB%ROWTYPE;
    CANTTOTAL NUMBER;
    REGMOVBAK CMOVPICK%ROWTYPE;
    CODOPEACTUAL VDUSUARIO.CODOPE%TYPE;
    MSJERROR VARCHAR2(2500);
    MISEQLINEA VDBULTOLIN.SEQLINEA%TYPE;
    NUEVOCODMOV VDMOVIM.CODMOV%TYPE;
    SALIR NUMBER:=0;
    EJEMOV NUMBER:=0;
    SALIRCICLO NUMBER:=0;
  BEGIN
   --Inicializamos variables
   CANTTOTAL := 0;
   RET:=0;
   -- Cambiamos el usuario
   CODOPEACTUAL:=VDUSER.GETUSER;
   SELECT *  INTO MIINFODISP FROM VDINFODISP WHERE IDINFOPICK = MIIDINFOPICK AND NUMDISP = MINUMDISP;
   PONUSUARIO(MIINFODISP.CODZONA);
  -- Recuperamos los datos del display
   -- Buscamos los movimientos del picking
   IF MIINFODISP.CANTVALIDADADISP>=0 THEN
     FOR REGMOV IN CMOVPICK LOOP
        SALIR:=0;
        EJEMOV:=1;
        REGMOVBAK := REGMOV;
        CANTTOTAL := CANTTOTAL + REGMOV.CANTIDAD;
        --Miramos si la cantidad confirmada en el display es la esperada
        IF (CANTTOTAL > MIINFODISP.CANTVALIDADADISP) THEN
          IF REGMOV.CANTIDAD - ( CANTTOTAL - MIINFODISP.CANTVALIDADADISP)>0 THEN
             -- Duplicamos el movimiento
             NUEVOCODMOV:=0;
             --LIMITE := REGMOV.CANTIDAD - ( CANTTOTAL - MIINFODISP.CANTVALIDADADISP); -- LÍMITE DE MOVTOS A EJECUTAR
             IF (VDMOV.PARTEMOV(REGMOV.CODMOV, REGMOV.CANTIDAD - ( CANTTOTAL - MIINFODISP.CANTVALIDADADISP)  ,NUEVOCODMOV ,'N')<0) THEN
               VDLOG.PONERROR('EJECUTAMOV','ERROR PARTIENDO MOVIMIENTO', REGMOV.CODMOV ,'POR CANTIDAD', REGMOV.CANTIDAD - ( CANTTOTAL - MIINFODISP.CANTVALIDADADISP));
               RET:=-1;
               RETURN;
             END IF;
          ELSE
            EJEMOV:=0;
          END IF;
          SALIR:= 1;
        END IF;
        SELECT * INTO ART FROM VDARTIC WHERE CODART = REGMOV.CODART;
        SELECT *  INTO PEC
          FROM VDPEDIDOCAB
         WHERE CODPED = REGMOV.CODPED AND CODDIV = REGMOV.CODDIV AND SEQPED = REGMOV.SEQPED AND ANOPED = REGMOV.ANOPED;
        -- si el artículo tiene número de serie, antes de ejecutar los movtos los va partiendo 1 a 1
        IF NVL(ART.SWTNUMEROSERIE,'-') = 'S' AND NVL(PEC.SWTNUMEROSERIE,'-') = 'S' THEN
          NUEVOCODMOV := REGMOV.CODMOV;
          SALIRCICLO:=0;
          WHILE SALIRCICLO=0 LOOP
            SELECT * INTO MOV FROM VDMOVIM WHERE CODMOV = NUEVOCODMOV;
            SELECT SEQLINEA INTO MISEQLINEA FROM VDBULTOLIN WHERE CODBULTO=REGMOV.CODBULTO AND CODMOV=MOV.CODMOV;
            IF MOV.CANTIDAD = 1 THEN SALIRCICLO:=1;
            ELSE
              IF VDMOV.PARTEMOV(MOV.CODMOV, 1  ,NUEVOCODMOV ,'N')<0 THEN
               VDLOG.PONERROR('EJECUTAMOV','ERROR PARTIENDO MOVIMIENTO', MOV.CODMOV ,'POR CANTIDAD', 1);
               RET:=-1;
               RETURN;
              END IF;
            END IF;
            IF MOV.CANTIDAD>0 THEN
               IF VDACTSTOCK.EJECUTAMOV(MOV.CODMOV, MSJERROR) <> 0 THEN
                   VDLOG.PONERROR('EJECUTAMOV','MOVIMIENTO:',MOV.CODMOV,'.',MSJERROR);
                   VDCOM.CREACOMENRELOGIN('VDMOVIM',MOV.CODCOMEN, 'INCIDENCIA', 1, SUBSTR(MSJERROR,1,512));
                   RET:=-1;
                   RETURN;
                END IF;
              ELSE
                   UPDATE VDMOVIM SET STATUS=VDST.FMOVANULADO WHERE CODMOV=MOV.CODMOV;
              END IF;
          END LOOP;
        ELSE
          IF EJEMOV >0  THEN
            IF REGMOV.CANTIDAD>0 THEN
                IF VDACTSTOCK.EJECUTAMOV(REGMOV.CODMOV, MSJERROR) <> 0 THEN
                    VDLOG.PONERROR('EJECUTAMOV','MOVIMIENTO:',REGMOV.CODMOV,'.',MSJERROR);
                    VDCOM.CREACOMENRELOGIN('VDMOVIM',REGMOV.CODCOMEN, 'INCIDENCIA', 1, SUBSTR(MSJERROR,1,512));
                    RET:=-1;
                    RETURN;
                  END IF;
             ELSE
                   UPDATE VDMOVIM SET STATUS=VDST.FMOVANULADO WHERE CODMOV=REGMOV.CODMOV;
             END IF;
          END IF;
        END IF;
        IF SALIR=1 THEN EXIT; END IF;
        IF RET<>0 THEN RETURN; END IF;
     END LOOP;
   ELSE
     REGMOVBAK.CODBULTO := MIINFODISP.CODBULTO;
   END IF;
  -- Actualizamos el usuario
  VDUSER.SETUSER(CODOPEACTUAL);
   RET := 0;
  EXCEPTION
     WHEN OTHERS THEN
          RET := -1;
          VDLOG.PONERROR('EJECUTAMOV','ERROR EJECUTANDO MOVIMIENTOS DEL DISPLAY',MIINFODISP.CODZONA,'-',MIIDINFOPICK,'-',MINUMDISP);
  END EJECUTAMOV;


      FUNCTION DECREMENTA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
        SIRVEN NUMBER;
       BEGIN
          SIRVEN:=DAMESERVIDO(MIIDINFOPICK,MINUMDISP);
          IF SIRVEN>0 THEN
              UPDATE VDINFODISP SET CANTVALIDADADISP=SIRVEN-1 WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
              VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           END IF;
           RETURN 0;
        END;
                
      FUNCTION DECREMENTAX0(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
        MIDISP VDINFODISP%ROWTYPE;
       BEGIN
          SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
          IF MIDISP.QUEDAN>0 THEN
              UPDATE VDINFODISP SET QUEDAN=QUEDAN-1  WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
              VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           END IF;
           RETURN 0;
        END; 
        
      FUNCTION INCREMENTAX0(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
       BEGIN
              UPDATE VDINFODISP SET QUEDAN=QUEDAN+1  WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
              VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           RETURN 0;
        END;

      FUNCTION INCREMENTA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
         MICODMOV NUMBER;
         PIDEN NUMBER;
         SIRVEN NUMBER;
       BEGIN
         MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
         IF MICODMOV!=0 THEN
             SELECT CANTIDAD INTO PIDEN FROM VDMOVIM WHERE CODMOV=MICODMOV;
           ELSE
             PIDEN:=0;
          END IF;
          SIRVEN:=DAMESERVIDO(MIIDINFOPICK,MINUMDISP);
          IF SIRVEN<PIDEN THEN
              UPDATE VDINFODISP SET CANTVALIDADADISP=SIRVEN+1 WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
              VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           END IF;
           RETURN 0;
        END;

    FUNCTION DEFECTO(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
       MICODZONA NUMBER;
       MICODART VDARTIC.CODART%TYPE;
       MIDESART VDARTIC.DESART%TYPE;
       MICODEAN VDARTIC.CODEAN%TYPE;
       MISTOCK NUMBER;
       MIBOCA NUMBER;
       MILUCES VDINFOHARDDISP.LUCES%TYPE;
       CUB NUMBER;
       MICODUBI VDUBICA.CODUBI%TYPE;
      BEGIN
        BEGIN
          SELECT CODZONA INTO MICODZONA FROM VDZONAS WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
          VALORZONA(MICODZONA);
          EXCEPTION WHEN NO_DATA_FOUND THEN 
           BEGIN
             MILUCES:='AZUL';
             MICODART:='';MISTOCK:=0;MICODEAN:='';MIDESART:='';MIBOCA:=0;CUB:=0;
             SELECT CODUBI INTO MICODUBI FROM VDINFODISP 
              WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
             SELECT CODART,TRANSLATE(DESART,',',' '),SUM(CANTIDAD) CANTIDAD,SUM(CUB),CODEAN,
                     SUM(CASE WHEN FILA=1 THEN CANTIDAD ELSE 0 END),CASE WHEN CODART IS NULL THEN NULL WHEN NVL(SUM(CANTIDAD),0)=0 THEN 'VERDE' ELSE 'ROJO' END 
                INTO MICODART,MIDESART,MISTOCK,CUB,MICODEAN,
                     MIBOCA,MILUCES
              FROM (
               SELECT STK.CODART,ART.DESART,STK.CANTIDAD,CEIL(STK.CANTIDAD/STK.UNIEMB) CUB,SUBSTR(ART.CODEAN,2,3) CODEAN,ROW_NUMBER() OVER(ORDER BY DECODE(UBI.CODAREA,'PUL',POSCONTE,ORDENSTK)) FILA,
                      UBI.CODAREA
                 FROM VDCONTE CNT,VDSTOCK STK,VDARTIC ART,VDUBICA UBI
                 WHERE CNT.CODMAT=STK.CODMAT AND CNT.CODUBI=MICODUBI AND STK.CODART=ART.CODART AND UBI.CODUBI=CNT.CODUBI
               )
              GROUP BY CODART,DESART,CODEAN;
              EXCEPTION WHEN NO_DATA_FOUND THEN NULL;
            END;
           VDECOPKG.PONMENSAJEDISPLAY(MIIDINFOPICK, MINUMDISP, '@UB. '||MICODUBI||',1,1,1'||
                                                               '@AR. '||MICODART||' EA. '||MICODEAN||',1,1,2'||
                                                               '@'||SUBSTR(MIDESART,1,20)||',1,1,3'||
                                                               '@ST. '||MISTOCK||' CB. '||CUB||' BO. '||MIBOCA||',1,1,4');
        END;
        RETURN 0;
    END;
   
    
   FUNCTION VALIDA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
     MIHARDDISP VDINFOHARDDISP%ROWTYPE;
     MICODMOV NUMBER;
     PIDEN NUMBER;
     SIRVEN NUMBER;
     RET NUMBER;
     STKENBOCA NUMBER;
   BEGIN
     MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
     IF MICODMOV!=0 THEN
        SELECT CANTIDAD INTO PIDEN FROM VDMOVIM WHERE CODMOV=MICODMOV;
      ELSE
        PIDEN:=0;
     END IF;
     SELECT * INTO MIHARDDISP FROM VDINFOHARDDISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     SIRVEN:=DAMESERVIDO(MIIDINFOPICK,MINUMDISP);
     STKENBOCA:=ENBOCA(MIIDINFOPICK,MINUMDISP);
     UPDATE VDINFODISP SET CANTVALIDADADISP=SIRVEN,CANTPEDIDADISP=PIDEN,CODMOV=MICODMOV WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     VDLOG.PONMENSAJE('VALIDA','DISPLAY',MIIDINFOPICK,MINUMDISP,'PIDEN',PIDEN,'SIRVEN',MIHARDDISP.TEXTO);
     IF SIRVEN<PIDEN OR SIRVEN>=STKENBOCA THEN
        IF SIRVEN>=STKENBOCA THEN
           UPDATE VDINFODISP SET STATUS=VDST.FIDIPASOX0,QUEDAN=0 WHERE  IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
         ELSE
           UPDATE VDINFODISP SET STATUS=VDST.FIDISIRVEMENOS WHERE  IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
        END IF;
        VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
        RETURN 0;
      END IF;
     EJECUTAMOV(MIIDINFOPICK, MINUMDISP,RET);
     CONTINUAPICKING(MIIDINFOPICK,MINUMDISP,MICODMOV);
     RETURN RET;
    END;
  
   FUNCTION VALIDAX0(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
     MICODMOV NUMBER;
     MIMOV VDMOVIM%ROWTYPE;
     MIDISP VDINFODISP%ROWTYPE;
     MICODAREA VDUBICA.CODAREA%TYPE;
     RET NUMBER;
   BEGIN
     SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     SELECT * INTO MIMOV FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV;
     IF MIDISP.QUEDAN>0 THEN
       DECLARE
        MISTOCK VDSTOCK%ROWTYPE;
        MICODMATORI VDCONTE.CODMAT%TYPE;
        MSJERROR VARCHAR2(1000);
       BEGIN
         SELECT * INTO MIMOV FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV;
         SELECT * INTO MISTOCK FROM VDSTOCK WHERE CODMAT=MIMOV.CODMATORI AND ROWNUM=1;
         MICODMATORI:=PFPKG.DAMECODMATUBI('REGULARIZA');
         VDMOV.CREAMOV(MICODMOV, 'REGULARIZA', 'REG+', VDST.FMOVPDTERECOGE, MICODMATORI, MIMOV.CODUBIORI, MIMOV.CODMATORI, MISTOCK.CODART, MISTOCK.CODLOT, MISTOCK.UNIEMB, MISTOCK.BLOQUEOS, MIDISP.QUEDAN,MIBLOQUEOSDEST=>MISTOCK.BLOQUEOS);
         RET:=VDACTSTOCK.EJECUTAMOV(MICODMOV, MSJERROR);
       END;
      END IF;
     EJECUTAMOV(MIIDINFOPICK, MINUMDISP,RET);
     IF MIDISP.QUEDAN=0 THEN
       SELECT CODAREA INTO MICODAREA
         FROM VDUBICA UBI,VDINFODISP IDI
         WHERE IDI.IDINFOPICK=MIIDINFOPICK AND IDI.NUMDISP=MINUMDISP AND IDI.CODUBI=UBI.CODUBI;
       IF MICODAREA='PUL' THEN 
          IF VD.GETPROP('CONFVACIA')='S' THEN
             UPDATE VDINFODISP SET STATUS=VDST.FIDICONFVACIA,CODMAT=MIMOV.CODMATORI WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
             VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
             RETURN RET;
           ELSIF VD.GETPROP('CONFSIGUIENTE')='S' THEN 
             UPDATE VDINFODISP SET STATUS=VDST.FIDICONFSIG,CODMAT=MIMOV.CODMATORI WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
             VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
             RETURN RET;
          END IF;
        END IF;
      END IF;
     CONTINUAPICKING(MIIDINFOPICK,MINUMDISP,MIDISP.CODMOV);
     RETURN RET;
    END;
    
   FUNCTION VALIDAREG(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
     MICODMOV NUMBER;
     MIDISP VDINFODISP%ROWTYPE;
     MICODAREA VDUBICA.CODAREA%TYPE;
     RET NUMBER;
     HAY NUMBER;
     MIMOV VDMOVIM%ROWTYPE;
   BEGIN
     SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     SELECT * INTO MIMOV FROM VDMOVIM WHERE CODMOV=MIDISP.CODMOV;
     EJECUTAMOV(MIIDINFOPICK, MINUMDISP,RET);
     HAY:=ENBOCA(MIIDINFOPICK,MINUMDISP);
     IF HAY>MIDISP.CANTVALIDADADISP THEN
       DECLARE
        MICODMATDEST VDCONTE.CODMAT%TYPE;
        MISTK VDSTOCK%ROWTYPE;
        MSJERROR VARCHAR2(1000);
       BEGIN 
         MICODMATDEST:=PFPKG.DAMECODMATUBI('REGULARIZA');
         SELECT * INTO MISTK FROM VDSTOCK WHERE CODMAT=MIMOV.CODMATORI AND CODART=MIMOV.CODART AND CODLOT=MIMOV.CODLOT AND ROWNUM=1;
         VDMOV.CREAMOV(MICODMOV, 'REGULARIZA', 'REG-', VDST.FMOVPDTERECOGE, MIMOV.CODMATORI, 'REGULARIZA', MICODMATDEST, MISTK.CODART, MISTK.CODLOT, MISTK.UNIEMB, MISTK.BLOQUEOS,HAY);
         RET:=VDACTSTOCK.EJECUTAMOV(MICODMOV, MSJERROR);
       END;
      END IF;
     SELECT CODAREA INTO MICODAREA
       FROM VDUBICA UBI,VDINFODISP IDI
       WHERE IDI.IDINFOPICK=MIIDINFOPICK AND IDI.NUMDISP=MINUMDISP AND IDI.CODUBI=UBI.CODUBI;
     IF MICODAREA='PUL' THEN 
        IF VD.GETPROP('CONFVACIA')='S' THEN
           UPDATE VDINFODISP SET STATUS=VDST.FIDICONFVACIA,CODMAT=MIMOV.CODMATORI WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
           VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           RETURN RET;
         ELSIF VD.GETPROP('CONFSIGUIENTE')='S' THEN 
           UPDATE VDINFODISP SET STATUS=VDST.FIDICONFSIG,CODMAT=MIMOV.CODMATORI WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
           VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
           RETURN RET;
        END IF;
      END IF;
     CONTINUAPICKING(MIIDINFOPICK,MINUMDISP,MIDISP.CODMOV);
     RETURN RET;
    END;
    
   FUNCTION VALIDAFIN(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
      MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
      MIDISP VDINFODISP%ROWTYPE;
      QUEDAN NUMBER;
      MICODMOV NUMBER;
      PIDEN NUMBER;
     BEGIN
       SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
       MICODBULTO:=DAMEBULTOMOV(MIDISP.CODMOV);
       DELETE VDBULTOZONA WHERE CODZONA=MIDISP.CODZONA AND CODBULTO=MICODBULTO;
       SELECT COUNT(*) INTO QUEDAN FROM VDBULTOZONA WHERE CODZONA=MIDISP.CODZONA AND STATUS>=VDST.FBZOENCURSO AND ROWNUM=1;
       IF QUEDAN=0 THEN 
          VDECOMENU.CAMBIASTATUSZONA(MIDISP.CODZONA,VDST.FZONABIERTA);
          VALORZONA(MIDISP.CODZONA);
          UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
         ELSE
          MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
          IF MICODMOV!=0 THEN  
             MICODBULTO:=DAMEBULTOMOV(MICODMOV);      
             PIDEN:=ENCIENDEUNO(MICODBULTO, MIIDINFOPICK, MINUMDISP);
            ELSE
              UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
           END IF;
        END IF;
       VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
       RETURN 0;
     END;
     
   FUNCTION VALIDAFINBULTO(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
      MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
      MIDISP VDINFODISP%ROWTYPE;
      QUEDAN NUMBER;
      MICODMOV NUMBER;
      PIDEN NUMBER;
     BEGIN
       SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
       SELECT CODBULTO INTO MICODBULTO FROM VDBULTOZONA WHERE CODZONA=MIDISP.CODZONA AND STATUS=VDST.FBZOENCURSO;
       DELETE VDBULTOZONA WHERE CODZONA=MIDISP.CODZONA AND CODBULTO=MICODBULTO;
       SELECT COUNT(*) INTO QUEDAN FROM VDBULTOZONA WHERE CODZONA=MIDISP.CODZONA AND STATUS>=VDST.FBZOENCURSO AND ROWNUM=1;
       IF QUEDAN=0 THEN 
          VDECOMENU.CAMBIASTATUSZONA(MIDISP.CODZONA,VDST.FZONABIERTA);
          VALORZONA(MIDISP.CODZONA);
          UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
         ELSE
          MICODMOV:=DAMECODMOV(MIIDINFOPICK,MINUMDISP);
          IF MICODMOV!=0 THEN  
             MICODBULTO:=DAMEBULTOMOV(MICODMOV);      
             PIDEN:=ENCIENDEUNO(MICODBULTO, MIIDINFOPICK, MINUMDISP);
            ELSE
              UPDATE VDINFODISP SET STATUS=VDST.FIDILIBRE WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
           END IF;
        END IF;
       VALORZONA(MIDISP.CODZONA);
       RETURN 0;
     END;
     
  FUNCTION VALIDACIERRE(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
    MIDISP VDINFODISP%ROWTYPE;
    MIESTADOBOT NUMBER;
   BEGIN
     SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     SELECT ESTADOBOT INTO MIESTADOBOT FROM VDINFOHARDDISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     IF MIESTADOBOT>=16 THEN
        REVISAFINPICKING(MIIDINFOPICK,MINUMDISP,MIDISP.CODMOV);
      END IF;
     RETURN 0;
   END;
    
  FUNCTION ANULAREG(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
   BEGIN
     UPDATE VDINFODISP SET STATUS=VDST.FIDIPICKING,CANTVALIDADADISP=CANTPEDIDADISP,QUEDAN=0 WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     VALORDISPLAY(MIIDINFOPICK,MINUMDISP);
     RETURN 0;
   END;
    
  
  FUNCTION VALIDAZONA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER) RETURN NUMBER IS
     MIDISP VDINFODISP%ROWTYPE;
     MICODBULTO VDBULTOCAB.CODBULTO%TYPE;
     HAY NUMBER;
   BEGIN
     SELECT * INTO MIDISP FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     UPDATE VDBULTOZONA SET STATUS=VDST.FBZOENCURSO WHERE STATUS=VDST.FBZOPDTECONF AND CODZONA=MIDISP.CODZONA RETURNING CODBULTO INTO MICODBULTO;
     IF SQL%ROWCOUNT>0 THEN 
        HAY:=ENCIENDEDISPLAYS(MIDISP.CODZONA, MICODBULTO);
        VDECOMENU.CAMBIASTATUSZONA(MIDISP.CODZONA, VDST.FZONCONBULTO);
      END IF;
     VALORZONA(MIDISP.CODZONA);
     RETURN 0;
   END;
      
  FUNCTION PROCESATECLA(MIIDINFOPICK NUMBER,MINUMDISP NUMBER,MITECLA NUMBER,FUNCION VARCHAR2) RETURN NUMBER IS
    RET NUMBER;
    MICODZONA NUMBER;
    CODOPEACTUAL VDUSUARIO.CODOPE%TYPE;
   BEGIN
     CODOPEACTUAL:=VDUSER.GETUSER;
     SELECT CODZONA INTO MICODZONA FROM VDINFODISP WHERE IDINFOPICK=MIIDINFOPICK AND NUMDISP=MINUMDISP;
     PONUSUARIO(MICODZONA);
     EXECUTE IMMEDIATE 'BEGIN :RET:='||FUNCION||'; END;' USING OUT RET,MIIDINFOPICK,MINUMDISP,MITECLA;
     VDUSER.SETUSER(CODOPEACTUAL);
     RETURN RET;
   END;
    
END;
/
