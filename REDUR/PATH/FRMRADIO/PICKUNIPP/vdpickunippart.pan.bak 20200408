# Módulo   : VDPICKUNIPPART.PAN
# Función  : Formulario de recogida de bultos de monopedido.
#            Pantalla de confirmación de cantidades.
#
# Creación : 02-04-2020
# Autor    : FPD
###########################################
# Histórico de cambios:
#
MONOPEDIDO
_10_______ _10_______
_____________________
PED._20________  @L@@@@
MAT: _255__________________
UBICACION: _20_____________
      
ARTICULO: _40_____________
  _20_________________
  _20_________________ 
_5___ _40_________________
CANTIDAD : #L#############
CAJAS  ENVASES UNIDADES
@@@@@   @@@@@   @@@@@

NUEVA MAT.: _
|

PREQUERY=FEJECUTA("CINICAMPOS","",
                  "+CSELDECIMALES","",
				  "COCULTACAMPOS","",
				  FPOSICIONACAMPO(FSUCCESS,"UNIDADES"),"\n\n ERROR AL POSICIONAR")

POSTQUERY=FEJECUTA("+CCALCSERV","",
				   "CMENORIGUAL","\n\n LA CANTIDAD\n SUPERA\n LA PEDIDA",
				   "CVALIDAMOV","\n\n ERROR\n :MSJERROR",
                   "CERROR","\n\n ERROR\n :MSJERROR",
                   FCOMMIT,"\n\n ERROR\n HACIENDO COMMIT",
                   FIF("CSIGNOTNULL",FPOSICIONABLOQUE(":SIGBLOQUE"),FSUCCESS),"\n\n ERROR\n CARGANDO SIGUIENTE\n BLOQUE",
				   FIF("CSELLINEASPEND",FIF("CHAYNUEVAMAT",FEJECUTA("CNUEVAMAT","",
                                                                    "CVERERROR",":MSJERROR",
                                                                    FCOMMIT,"",
                                                                    FPOSICIONABLOQUE("VDPICKUNIPPMAT.PAN"),""),
                                                           FPOSICIONABLOQUE("VDPICKUNIPPPDTE.PAN")),
                                        FPOSICIONABLOQUE("VDPICKUNIPPFIN.PAN")),"\n\n ERROR\n CARGANDO SIGUIENTE\n BLOQUE")

#DEFINICION DE CAMPOS
CAMPO=CODRECURSO,VIRTUAL,NOENTER
CAMPO=CODOPE,VIRTUAL,NOENTER
CAMPO=TEXTOTAREA,VIRTUAL,NOENTER
CAMPO=CODPED,VIRTUAL,NOENTER
CAMPO=NBULTO,VIRTUAL,NOENTER
CAMPO=MATCAJA,VIRTUAL,NOENTER
CAMPO=PINTAUBI,VIRTUAL,NOENTER
CAMPO=CODART,VIRTUAL,NOENTER
CAMPO=DESART1,VIRTUAL,NOENTER
CAMPO=DESART2,VIRTUAL,NOENTER
CAMPO=NCODLOT,VIRTUAL,NOENTER
CAMPO=CODLOT,VIRTUAL,NOENTER
CAMPO=CANTIDAD,VIRTUAL
CAMPO=CAJAS,VIRTUAL
CAMPO=ENVASES,VIRTUAL
CAMPO=UNIDADES,VIRTUAL
CAMPO=CODBULTO,VIRTUAL,OCULTO
CAMPO=CODMOV,VIRTUAL,OCULTO
CAMPO=SWTLOTE,VIRTUAL,OCULTO
CAMPO=MSGERROR,VIRTUAL,OCULTO
CAMPO=LONGERROR,VIRTUAL,OCULTO
CAMPO=SERVIDA,VIRTUAL,OCULTO
CAMPO=UNIEMB,VIRTUAL,OCULTO
CAMPO=UNIPAQ,VIRTUAL,OCULTO
CAMPO=CODMATORI,VIRTUAL,OCULTO
CAMPO=SKORIG,VIRTUAL,OCULTO
CAMPO=ORDENSTK,VIRTUAL,OCULTO
CAMPO=SEQLINEA,VIRTUAL,OCULTO
CAMPO=CODUBIORI,VIRTUAL,OCULTO
CAMPO=RET,VIRTUAL,OCULTO
CAMPO=MSJERROR,VIRTUAL,OCULTO
CAMPO=SIGBLOQUE,VIRTUAL,OCULTO
CAMPO=NUEVAMAT


#DEFINICION DE CURSORES

CURSOR=CINICAMPOS SELECT 'N' NUEVAMAT, NULL MSJERROR FROM DUAL;

CURSOR=CHAYNUEVAMAT SELECT :NUEVAMAT FROM DUAL WHERE :NUEVAMAT = 'S';

CURSOR=CNUEVAMAT DECLARE
                   MINUEVOBULTO VDBULTOCAB.CODBULTO%TYPE;
                 BEGIN
                   VDCLIPKG.PARTEBULTO(:CODBULTO, MINUEVOBULTO, :MSJERROR);
                 END;@
                 
CURSOR=CVERERROR SELECT :MSJERROR FROM DUAL WHERE :MSJERROR IS NULL;

CURSOR=CSELLINEASPEND SELECT :CODBULTO
                        FROM VDBULTOCAB CB, VDBULTOLIN LB
                       WHERE CB.CODBULTO = :CODBULTO AND
                             LB.CODBULTO = CB.CODBULTO AND
                             LB.STATUS = VDST.FBULASERVIR;

CURSOR=CSIGNOTNULL SELECT :SIGBLOQUE FROM DUAL WHERE :SIGBLOQUE IS NOT NULL;

CURSOR=CERROR SELECT :RET FROM DUAL WHERE :RET=0;

CURSOR=CVALIDAMOV BEGIN
                   :RET:=VDCLIPICK.VALIDAMOV(:CODRECURSO,:CODBULTO,:SEQLINEA,:SERVIDA,0,0,0,0,:MSJERROR,:SIGBLOQUE);
                   IF :SIGBLOQUE = 'VDPICKUNIVDREG.PAN' THEN
                     :SIGBLOQUE := 'VDPICKUNIPPREG.PAN';
                   END IF;
                   IF :RET=0 THEN
                      COMMIT;
                    ELSE
                      ROLLBACK;
                   END IF;
                  END;@
                  
CURSOR=CSELDECIMALES SELECT ART.DECIMALES CANTIDAD__DECIMALES FROM VDARTIC ART WHERE CODART = :CODART;

CURSOR=COCULTACAMPOS SELECT DECODE(:SWTLOTE, 'S', 0, 1) NCODLOT__INVISIBLE,
                            DECODE(:SWTLOTE, 'S', 0, 1) CODLOT__INVISIBLE,
							'LOTE:' NCODLOT
                       FROM DUAL;
							
CURSOR=CCALCSERV SELECT (:CAJAS*:UNIEMB)+(:ENVASES*:UNIPAQ)+:UNIDADES SERVIDA FROM DUAL;
							 
CURSOR=CMENORIGUAL SELECT :SERVIDA FROM DUAL WHERE :SERVIDA<=:CANTIDAD;
