#VDINTERRECEPLETI - Envío de recepciones de cliente LETI

CAMPO=HFICHERO,AUXILIAR,OCULTO,"@L@@@@@@@@@@"
CAMPO=CODDIV,AUXILIAR,OCULTO,"____"

BEGINBLOQUEFRM=VDINTERRECEP
   TABLA=DUAL
   SOLOQUERY

   SELECT=SELECT DISTINCT BUZONOUT BUZONOUT, '' FTPHOST, '' FTPUSUARIO, '' FTPCLAVE, /*NVL(FTPRUTA,'.')*/ '' FTPRUTA, 'RECEP'||TO_CHAR(SYSDATE,'DDMMYYYYHH24MISS')||'.TXT' NOMBREFICH
           FROM VDDIVIS
           WHERE CODDIV=:CODDIV AND  EXISTS     (SELECT 1
				   FROM VDORDRECCAB ORC,VDRECEPCAB RCC
				  WHERE ORC.CODORDREC=RCC.CODORDREC AND ORC.CODDIV=RCC.CODDIV AND
						ORC.TIPORDREC=RCC.TIPORDREC AND RCC.CODDIV=:CODDIV AND
						RCC.STATUS=VDST.FRCCFINALIZADA);

   CAMPO=CODDIV,AUXILIAR,VIRTUAL,OCULTO
   CAMPO=BUZONOUT,AUXILIAR,OCULTO,"_256"
   CAMPO=HFICHERO,AUXILIAR,VIRTUAL,OCULTO
   CAMPO=FTPHOST,AUXILIAR,OCULTO,"_50"
   CAMPO=FTPUSUARIO,AUXILIAR,OCULTO,"_50"
   CAMPO=FTPCLAVE,AUXILIAR,OCULTO,"_50"
   CAMPO=FTPRUTA,AUXILIAR,OCULTO,"_100"
   CAMPO=NOMBREFICH,AUXILIAR,OCULTO, "_100"
ENDBLOQUE

BEGINBLOQUEFRM=VDINTERRECEPCAB
  PADRE=VDINTERRECEP
  TABLA=RECEP CAB
  SOLOQUERY
  
  PREBLOQUE=FEJECUTA(FABREFICHERONOMBRE(":BUZONOUT","HFICHERO",":NOMBREFICH"), "")
					 
  POSTBLOQUE=FEJECUTA(FCIERRAFICHERO(":HFICHERO"),"",
                      FCOMMIT,"")
#                      FIF("CTIENEFTP",FEJECUTA("CPARAMS","", FWINEXEC("E:\V10\DP\CMD\SCRIPTS\FTP_GENERICO.CMD :PARAMSFTP"),"")),"")
  POSTQUERY=FESCRIBEFICHERO(":HFICHERO")


# POSTQUERY=FEJECUTA(FESCRIBEFICHERO(":HFICHERO"),"No puedo escribir en fichero",
#                     FCOMMITFICHERO(":HFICHERO"),"No puedo hacer comit en los ficheros")
    
  SELECT=SELECT 'CAB' TIPOREG,ORC.TIPORDREC,ORC.CODORDREC,RCC.CODRECEP, RCC.CODDIV, ORC.CLAVEEXT CODALBTRAN, DESTRAN, CODALBPROVE, RCC.CLAVEEXT, to_char(to_date(to_char(FECRECEP),'J'), 'YYYYMMDD') FECRECEP, HORARECEP, RCC.OBSERVACION1 || RCC.OBSERVACION2  OBSERVACION
           FROM VDORDRECCAB ORC,VDRECEPCAB RCC
          WHERE ORC.CODORDREC=RCC.CODORDREC AND ORC.CODDIV=RCC.CODDIV AND
                ORC.TIPORDREC=RCC.TIPORDREC AND RCC.CODDIV=:CODDIV AND
                RCC.STATUS=VDST.FRCCFINALIZADA;
				
#CURSOR=CTIENEFTP SELECT :FTPHOST FTPHOST FROM DUAL WHERE :CODDIV IN ('LE','LV');

#  CURSOR=CPARAMS SELECT :FTPHOST||' '||:FTPUSUARIO||' '||:FTPCLAVE||' '||:BUZONOUT||'\'||:NOMBREFICH||' '||:FTPRUTA||' S' PARAMSFTP FROM DUAL;
  
  CAMPO=HFICHERO,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=CODDIV,AUXILIAR,VIRTUAL,OCULTO 
  CAMPO=BUZONOUT,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=CODRECEP,AUXILIAR,OCULTO,"_20_"
  CAMPO=NOMBREFICH,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=FTPHOST,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=FTPUSUARIO,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=FTPCLAVE,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=FTPRUTA,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=PARAMSFTP,AUXILIAR,OCULTO,"_500"
ENDBLOQUE


BEGINBLOQUEFRM=VDINTERRECEPLIN
  PADRE=VDINTERRECEPCAB
  TABLA=RECEP LIN
  SOLOQUERY

  POSTQUERY=FEJECUTA(FESCRIBEFICHEROINTER(":HFICHERO","RECEP","LIN"),"No puedo escribir en fichero")
  POSTUPDATE=FEJECUTA("CUPDASTATUS","No puedo actualizar",FCOMMIT,"")

  CAMPO=HFICHERO,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=BUZONOUT,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=CODDIV,AUXILIAR,VIRTUAL,OCULTO 
  CAMPO=CODRECEP,AUXILIAR,VIRTUAL,OCULTO

  SELECT=SELECT 'LIN' TIPOREG,RCC.CODORDREC,RCL.SECLINREC,ART.CODART,RCL.SECLINORD, RCC.CODDIV, ORL.BLOQUEOLINEA BLOQSTOCK,RCC.CODRECEP,
                ART.UNIDADESHOST,RCL.CANTIDADR, RCL.CODLOT
           FROM VDRECEPCAB RCC,VDRECEPLIN RCL,VDARTIC ART,VDCONVERSIONES CON,VDLOTES LOT, VDORDRECLIN ORL
          WHERE RCC.CODRECEP=RCL.CODRECEP  AND RCL.CODART=ART.CODART AND
                CON.UNIDADORIGEN=ART.UNIDADESHOST AND CON.UNIDADDESTINO=ART.UNIDADES AND
                RCL.CODART=LOT.CODART AND RCL.CODLOT=LOT.CODLOT AND RCL.CODRECEP=:CODRECEP AND
				ORL.CODORDREC = RCL.CODORDREC AND ORL.CODDIV = RCL.CODDIV AND ORL.SECLINORD = RCL.SECLINORD
         GROUP BY RCC.TIPORDREC,RCC.CODORDREC,RCL.SECLINREC,ART.CODART,RCL.SECLINORD, RCC.CODDIV, ORL.BLOQUEOLINEA,
                ART.UNIDADESHOST,RCC.CODRECEP,RCL.CANTIDADR, RCL.CODLOT;
				
  CURSOR=CUPDASTATUS UPDATE VDRECEPCAB SET STATUS=VDST.FRCCINTERHOST, CODOPEMODIF=VDUSER.GETUSER,FECMODIF=VD.FECHASYS,HORAMODIF=VD.HORASYS
                       WHERE CODRECEP=:CODRECEP AND STATUS=VDST.FRCCFINALIZADA;
ENDBLOQUE
