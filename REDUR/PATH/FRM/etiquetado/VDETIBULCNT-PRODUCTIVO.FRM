BEGINBLOQUE=VDLEEMATRICULA.PAN
ENDBLOQUE
BEGINBLOQUE=VDBULCAB.PAN
  PADRE=VDLEEMATRICULA.PAN
  POSX=1
  POSY=7
  NOCOMMIT
  
  CAMPO=CODMATLEIDO,AUXILIAR,VIRTUAL,OCULTO
  CAMPO=NUMALBA,AUXILIAR,OCULTO,"@@@"
  CAMPO=SWTNUMEROSERIE,AUXILIAR,OCULTO,"_"
  CAMPO=MSJNUMEROSERIE,AUXILIAR,OCULTO,"_40_"

  WHERE=STATUS IN (VDST.FBUCAETIQUETAR, VDST.FBUCPREPARADO) AND TIPOBULTO='C' AND CODBULTO IN 
        (SELECT CODBULTO FROM VDBULTOLIN BUL, VDMOVIM MOV WHERE MOV.CODMATORI = :CODMATLEIDO AND MOV.CODMOV = BUL.CODMOV);  

  POSTQUERY=FDESIGNACION("CSIRVEBULTO","ERROR SIRVIENDO BULTO",
                         FCOMMIT,"ERROR EN COMMIT CSIRVEBULTO",
                         "+CNUMSERIE","ERROR OBTENIENDO SWTNUMEROSERIE",
                         "CETIQBUL","ERROR ETIQUETANDO BULTO",
                         FIF("CULTIMOBUL",FEJECUTA("CUPDBUL","ERROR ACTUALIZANDO EL BULTO",
                                                   "CSELNUMALBA","ERROR OBTENIENDO NUMERO DE COPIAS DE ALBARAN",
                                                   FIMPRIMEPEDIDO("INFORME",":CODDIV",":ANOPED",":CODPED",":SEQPED","$(VDALBARAN)","CODDIV=:CODDIV;ANOPED=:ANOPED;CODPED=:CODPED;SEQPED=:SEQPED","",":NUMALBA"),":V10ERROR",
                                                   FCOMMIT,"ERROR EN COMMIT",
                                                   %FFAILURE,"\n:MSJNUMEROSERIE\nETIQUETA IMPRESA\nINCLUIR ALBARAN EN EL\nBULTO :NBULTO DE PEDIDO :CODPED"),
                                          FEJECUTA(%FFAILURE,"\nETIQUETA IMPRESA PARA\nBULTO :NBULTO DE PEDIDO \n:CODPED \n:MSJNUMEROSERIE")),"",
                         FCOMMIT, "ERROR HACIENDO COMMIT",
                         FPULSATECLAS("F5"),"ERROR EN FPULSATECLAS")

  CURSOR=CSIRVEBULTO DECLARE
                       RET NUMBER;
                     BEGIN
                       VDBULTO.SIRVEBULTO(:CODBULTO,RET);
                     END;@
 
  CURSOR=CNUMSERIE SELECT SWTNUMEROSERIE, DECODE(SWTNUMEROSERIE,'L','LECTURAS DE NUMEROS DE SERIE','') MSJNUMEROSERIE
  FROM
  (
     SELECT  NVL(SWTNUMEROSERIE,'N') SWTNUMEROSERIE
     FROM VDBULTOLIN BUL, VDARTIC ART 
     WHERE CODBULTO = :CODBULTO
     AND ART.CODART = BUL.CODART
     ORDER BY DECODE(SWTNUMEROSERIE,'L',1,2)
  )X
  WHERE ROWNUM = 1;

  CURSOR=CETIQBUL BEGIN
                    UPDATE VDBULTOCAB SET STATUS= DECODE(:SWTNUMEROSERIE,'L',4060,VDST.FBUCENEXPED),
                                          FECIMPRIME=VD.FECHASYS,HORAIMPRIME=VD.HORASYS
                     WHERE CODBULTO=:CODBULTO;
                    VDIMPRIME.IMPRIME('ETIQ','VDETIQBU.GEN;VDETIQUETAS.VSQ;CSELBULTO','ESCOPIA=''N'';CODBULTO='||:CODBULTO,1,NULL,NULL,:V10ERROR,VDST.FISPPENDFICH);
					RDRPKG.IMPRIMEAMZNCCBULTO(:CODBULTO);
                  END;@
				
  CURSOR=CULTIMOBUL SELECT :CODBULTO FROM DUAL WHERE VDBULTO.DAMEULTBULTO(:CODBULTO)='S';

  CURSOR=CUPDBUL UPDATE VDBULTOCAB 
                    SET CODOPEVERIFICA=VDUSER.GETUSER,FECMODIF=VD.FECHASYS,HORAMODIF=VD.HORASYS,
                        FECVERIFICA=VD.FECHASYS,HORAVERIFICA=VD.HORASYS,
                        SWTLLEVAALB='S'
                    WHERE CODBULTO=:CODBULTO;				

  CURSOR=CSELNUMALBA SELECT PEC.NUMALBA 
                       FROM VDBULTOCAB BUC,VDPEDIDOCAB PEC
                      WHERE BUC.CODBULTO=:CODBULTO AND 
                            BUC.CODPED=PEC.CODPED AND BUC.ANOPED=PEC.ANOPED AND 
                            BUC.CODDIV=PEC.CODDIV AND BUC.SEQPED=PEC.SEQPED;

ENDBLOQUE
#BEGINBLOQUE=VDBULLIN.PAN
#  PADRE=VDBULCAB.PAN
#  PREQUERY=QUERYHIJO
#  POSX=1
#  POSY=31
#  REGPAG=15
#ENDBLOQUE
