##############################################################################
#  Módulo  : VDIMPBULBCE2.PAN                                                #
#  Función :                                                                 #
#                                                                            #
#  Autor : FPD                                                               #
#  Fecha : 14-10-14                                                          #
#  Revisador por  :                                                          #
#  Fecha revisión :                                                          #
##############################################################################
IMPRESION DE ETIQUETAS DE CAJA COMPLETA Y ASIGNACION DE TERMINAL 
 Ubicación    Artículo        Descripción                    Cajas S/N  Ola 
 ____________ _20____________ _40___________________________ @L@@@  _   @L,@@@@ 
|

SOLOQUERY
SELECT=SELECT SPR.CODSERIEPREP,MOV.CODUBIORI CODUBI,MOV.CODART,SUM(BUL.CANTPEDIDA)/MOV.UNIEMB CAJAS,'S' SWT
         FROM VDMOVIM MOV,VDUBICA UBO,VDUBICA UBD,VDRECURSO REC,VDPERFILTAREA PER,
              VDBULTOLIN BUL,VDBULTOCAB BUC,VDPEDIDOCAB PEC,VDSERIEPREP SPR
        WHERE MOV.STATUS+0=VDST.FMOVPDTERECOGE AND MOV.TAREA='PEDEMBA' AND UBO.CODUBI=MOV.CODUBIORI AND UBD.CODUBI=MOV.CODUBIDEST AND
              REC.CODRECURSO=:CODRECURSO AND PER.CODPERFIL='BULBCEPREV' AND
              PER.FORMPLANIF='N' AND ((UBO.CODAREA NOT LIKE 'HR%' AND :ALTURA='N') OR (UBO.CODAREA LIKE 'HR%' AND :ALTURA='S')) AND
              VD.CONTIENECAD(PER.RANTAREA,MOV.TAREA)=1 AND VD.CONTIENE(PER.RANAREAORI,UBO.CODAREA)=1 AND
              VD.CONTIENECAD(PER.RANAREADEST,UBD.CODAREA)=1 AND VD.CONTIENENUM(PER.RANCODZONORI,UBO.CODZONA)=1 AND
              VD.CONTIENENUM(PER.RANCODZONDEST,UBD.CODZONA)=1 AND 
              VDPLANMOV.COMPATUBIPERFIL(PER.CODCLASIFUBI,UBO.CODUBI,PER.RANCLASEUBIORI)=1 AND
              VDPLANMOV.COMPATUBIPERFIL(PER.CODCLASIFUBI,UBD.CODUBI,PER.RANCLASEUBIDEST)=1 AND
              VDPLANMOV.COMPATARTPERFIL(PER.CODCLASIFART,MOV.CODART,PER.RANCLASEART)=1 AND
              UBO.ALTURA<=PER.MAXALT AND UBD.ALTURA<=PER.MAXALT AND (UBO.ALTURA>=PER.MINALT OR UBD.ALTURA>=PER.MINALT) AND
              UBO.ALTURA BETWEEN REC.MINALT AND REC.MAXALT AND
              UBD.ALTURA BETWEEN REC.MINALT AND REC.MAXALT AND
              UBO.BLOQUEOSS = 'N' AND MOV.PRIOMOV BETWEEN PER.MINPRIOMOV AND PER.MAXPRIOMOV AND
              VDUSER.TIENEPRIVILEGIO(REC.CODOPE,PER.PRIVILEGIOSTAREA)=1 AND
              VDPLANMOV.PUEDEMOVER(PER.CONTENEDORES,PER.EMBALAJES,PER.UNIDADESSUELTAS,MOV.CODMATORI,MOV.CODMATDEST,MOV.CANTIDAD,MOV.UNIEMB)=1 AND
              VDPLANMOVCLIEN.COMPATIBLE(:CODRECURSO,PER.CODPERFIL,MOV.CODMOV)=1 AND
              MOV.CODMOV=BUL.CODMOV AND BUL.CODBULTO=BUC.CODBULTO AND BUC.STATUS+0=VDST.FBUCBULABAN AND BUC.TIPOBULTO='E' AND
              BUC.CODPED=PEC.CODPED AND BUC.CODDIV=PEC.CODDIV AND BUC.ANOPED=PEC.ANOPED AND BUC.SEQPED=PEC.SEQPED AND
              PEC.SWTNOETIQCC!='S' AND PEC.CODSERIEPREP=SPR.CODSERIEPREP AND SPR.STATUS=VDST.FSPRLANZADA;
GROUPBY=SPR.PRIORIDAD,SPR.CODSERIEPREP,MOV.CODUBIORI,MOV.CODART,MOV.UNIEMB,UBO.ORDENSALIDA;
ORDERBY=SPR.PRIORIDAD,SPR.CODSERIEPREP,UBO.ORDENSALIDA,MOV.CODUBIORI,MIN(MOV.CODMOV);


PREQUERY=FEJECUTA("CBORRAACUM","")

POSTQUERY=FEJECUTA("$-CSELNOLANZAR","","CASIGNASERIE","",&FMODIFICA,"")

FINQUERY=FEJECUTA(FIF("CPESOCERO",FEJECUTA("%-CBLOQLABEL","HAY SERIES BLOQUEADAS PARA ETIQUETADO")),"")

PRECOMMIT=FEJECUTA("CSELCODPREP","ERROR OBTENIENDO CODIGO DE PREPARACION")

POSTCOMMIT=FEJECUTA("CASIGNAREC","NO SE PUEDE ASIGNAR TERMINAL",FCOMMIT,"",FIF("CHAYALB",FEJECUTA(%FFAILURE,"RECOGER DOCUMENTACION \nDE LA IMPRESORA")),"",FPULSATECLAS("F5"))


PREUPDATE=FEJECUTA("@CVERSEL","",
                   "CASIGNAMOV","NO SE PUEDEN ASIGNAR MOVIMIENTOS",
                   "CSELBULTOETIQ","ERROR AL RECUPERAR LOS\n BULTOS A ETIQUETAR",
                   FIMPRIME("ETIQ","VDETARTBUL.GEN;VDARTIC.VSQ;CSELART","CODART=:CODART","N15WIFI"),"",
                   FWHILE(FERRORCURSOR("CSELBULTOETIQ"),
                                       FEJECUTA("CLLEVAALB","ERROR DECIDIENDO SI LLEVA ALBARAN",
                                                "CUPDBULTO","NO SE PUEDE ACTUALIZAR BULTO",
                                                FCOMMIT,"",
                                                FIMPRIMEBULTO("ETIQ",":CODBULTO","VDETIQBU.GEN;VDETIQUETAS.VSQ;CSELBULTO","CODBULTO=:CODBULTO","N15WIFI"),"ERROR AL IMPRIMIR ETIQUETA\n\n :V10ERROR",
                                                FIF("CSELALB",FEJECUTA("CCALCALB","NO SE PUEDE CALCULAR NUMERO DE ALBARANES"),
                                                              FSUCCESS),"",
                                               +FFETCHCURSOR("CSELBULTOETIQ"),"")
                         ),"ERROR EN FWHILE DE ETIQUETAS")


CAMPO=CODUBI,PREFIJO=UBO,TITULO("Ubicación")
CAMPO=CODART,UPPER,TITULO("Artículo")
CAMPO=DESART,UPPER,AUXILIAR,NOENTER,POSTCHANGE=FDESIGNACION("+CDESART",""),TITULO("Descripción")
CAMPO=PESO,AUXILIAR,NOENTER,OCULTO,"#L#.#"
CAMPO=TPESO,AUXILIAR,VIRTUAL,OCULTO
CAMPO=CODSERIEASIG,AUXILIAR,OCULTO,VIRTUAL
CAMPO=UNIEMB,OCULTO,"@L@@@@@@@"
CAMPO=CAJAS,TITULO("Cajas"),WLONX=20
CAMPO=SWT,AUXILIAR,UPPER,POSTCHANGE=FEJECUTA("CSELSIGNO","","CSELACUM","","&FRECALCPADRE",""),PROTECT("JEFEEQUIPO"),TITULO("S/N"),WLONX=30
CAMPO=CODSERIEPREP,NOENTER
CAMPO=CODRECURSO,AUXILIAR,VIRTUAL,OCULTO
CAMPO=MAXALT,VIRTUAL,AUXILIAR,OCULTO
CAMPO=DUMMY,AUXILIAR,OCULTO,"_"
CAMPO=LLEVO,AUXILIAR,VIRTUAL,OCULTO
CAMPO=SIGNO,AUXILIAR,OCULTO,"@L"
CAMPO=NUMALBA,VIRTUAL,AUXILIAR,OCULTO
CAMPO=CODBULTO,AUXILIAR,OCULTO,"_20_"
CAMPO=CODPREPARACION,AUXILIAR,VIRTUAL,OCULTO
CAMPO=CODPED,AUXILIAR,OCULTO,"_20_"
CAMPO=CODDIV,AUXILIAR,OCULTO,"_4_"
CAMPO=ANOPED,AUXILIAR,OCULTO,"@L@@"
CAMPO=SEQPED,AUXILIAR,OCULTO,"@L@"
CAMPO=NUMALBAPED,AUXILIAR,OCULTO,"@L@"
CAMPO=LLEVAALB,AUXILIAR,OCULTO,"_"
CAMPO=PROFORMA,AUXILIAR,OCULTO,"_"
CAMPO=TIPOPEDIDO,AUXILIAR,OCULTO,"_10_"
CAMPO=PEDIDOHOST,AUXILIAR,OCULTO,"_60_"
CAMPO=NOMBRERPT,AUXILIAR,OCULTO,"_60_"
CAMPO=RET,NOUPDATE,OCULTO,"@L"
CAMPO=ALTURA,AUXILIAR,VIRTUAL,OCULTO


CURSOR=CVERSEL SELECT :SWT FROM DUAL WHERE :SWT='S';


CURSOR=CPESOCERO SELECT :PESO FROM DUAL WHERE :PESO=0 AND :CODRECURSO IS NOT NULL;

CURSOR=CBLOQLABEL SELECT :PESO FROM VDSERIEPREP WHERE STATUS<VDST.FSPRFINALIZADA AND SWTBLOQETIQ='S';

CURSOR=CHAYALB SELECT :NUMALBA
                 FROM VDBULTOCAB BUC,VDBULTOLIN BUL
                WHERE BUC.STATUS+0=VDST.FBUCBULABANETI AND BUC.TIPOBULTO='E' AND BUC.SWTLLEVAALB='SI' AND 
                      BUC.CODBULTO=BUL.CODBULTO AND BUL.CODMOV IN (SELECT CODMOV FROM VDMOVIM
                                                                    WHERE STATUS=VDST.FMOVASIGNADO AND 
                                                                          CODRECURSO = :CODRECURSO AND 
                                                                          TAREA = 'PEDEMBA');


CURSOR=CBORRAACUM SELECT 0 TPESO,0 LLEVO,0 NUMALBA,-1 CODSERIEASIG FROM DUAL;

CURSOR=CCALCALB SELECT :NUMALBA+NVL(PEC.NUMALBA,0) NUMALBA,PEC.CODPED,PEC.CODDIV,PEC.ANOPED,PEC.SEQPED,PEC.NUMALBA NUMALBAPED,TIPOPEDIDO,NVL(PEC.SWTPROFORMA,'N') PROFORMA
                  FROM VDBULTOCAB BUC,VDPEDIDOCAB PEC
                  WHERE BUC.CODBULTO=:CODBULTO AND BUC.SWTLLEVAALB='S' AND 
                        BUC.CODPED=PEC.CODPED AND BUC.CODDIV=PEC.CODDIV AND BUC.ANOPED=PEC.ANOPED AND BUC.SEQPED=PEC.SEQPED;

CURSOR=CCALCALB2 SELECT PEC.CODPED,PEC.CODDIV,PEC.ANOPED,PEC.SEQPED                                                                                                            
                  FROM VDBULTOCAB BUC,VDPEDIDOCAB PEC
                  WHERE BUC.CODBULTO=:CODBULTO AND BUC.SWTLLEVAALB='S' AND 
                        BUC.CODPED=PEC.CODPED AND BUC.CODDIV=PEC.CODDIV AND BUC.ANOPED=PEC.ANOPED AND BUC.SEQPED=PEC.SEQPED;
                        
CURSOR=CSELSIGNO SELECT DECODE(:SWT,'S',1,'N',-1,0) SIGNO FROM DUAL;

CURSOR=CSELACUM SELECT :LLEVO+:CAJAS LLEVO
                  FROM DUAL;

CURSOR=CSELNOLANZAR SELECT 'N' SWT
                      FROM DUAL
                     WHERE ((:LLEVO+:CAJAS>VD.GETPROP('MAXBULABTERM') AND :LLEVO>VD.GETPROP('MAXBULABTERM')/2)) OR 
                           (:CODSERIEPREP!=(CASE WHEN :CODSERIEASIG=-1 THEN :CODSERIEPREP ELSE :CODSERIEASIG END));
                     
CURSOR=CASIGNASERIE SELECT :CODSERIEPREP CODSERIEASIG FROM DUAL;                     

CURSOR=CDESART SELECT DESART
                 FROM VDARTIC
                WHERE CODART=:CODART;

CURSOR=CVERSWT SELECT :SWT SWT
                 FROM DUAL
                WHERE :SWT='S';

CURSOR=CUPDALINBU UPDATE SGLLINBU SET CODINDREAL=(SELECT CODIND FROM SGLCABTE WHERE CODRECURSO=:CODRECURSO)
                      WHERE (CODPED,ANOPED,CODDIV,SEQPED,NBULTO) IN
                            (SELECT CODPED,ANOPED,CODDIV,SEQPED,NBULTO
                              FROM SGLCABBU
                              WHERE STATUS=#STCBBULABANGMI);

                    
CURSOR=CSELBULTOETIQ SELECT BUC.CODBULTO,NVL(PEC.SWTPROFORMA,'N') PROFORMA
                       FROM VDBULTOCAB BUC,VDBULTOLIN BUL,VDMOVIM MOV,VDPEDIDOCAB PEC
                      WHERE BUC.CODBULTO=BUL.CODBULTO AND BUC.STATUS+0=VDST.FBUCBULABAN AND BUC.TIPOBULTO='E' AND 
                            BUL.CODMOV=MOV.CODMOV AND MOV.CODUBIORI=:CODUBI AND MOV.CODART=:CODART AND MOV.STATUS=VDST.FMOVASIGNADO AND MOV.CODRECURSO=:CODRECURSO AND
                            BUC.CODPED=PEC.CODPED AND BUC.CODDIV=PEC.CODDIV AND BUC.ANOPED=PEC.ANOPED AND BUC.SEQPED=PEC.SEQPED ;

CURSOR=CSELCODPREP SELECT VDSECPREP.NEXTVAL CODPREPARACION FROM DUAL;                           
                            
CURSOR=CASIGNAMOV UPDATE VDMOVIM 
                     SET CODRECURSO=:CODRECURSO,
                         STATUS=VDST.FMOVASIGNADO,
                         CODPREPARACION=:CODPREPARACION,
                         FECMODIF=VD.FECHASYS,HORAMODIF=VD.HORASYS,
                         FECPLANMOV=VD.FECHASYS,HORAPLANMOV=VD.HORASYS
                   WHERE CODMOV IN (SELECT DISTINCT MOV.CODMOV FROM VDBULTOCAB BUC,VDBULTOLIN BUL,VDMOVIM MOV,VDPEDIDOCAB PEC,VDSERIEPREP SPR
                                     WHERE BUC.CODBULTO=BUL.CODBULTO AND BUC.STATUS+0=VDST.FBUCBULABAN AND BUC.TIPOBULTO='E' AND 
                                           BUL.CODMOV=MOV.CODMOV AND MOV.CODUBIORI=:CODUBI AND MOV.CODART=:CODART AND MOV.STATUS+0=VDST.FMOVPDTERECOGE AND
                                           BUC.CODPED=PEC.CODPED AND BUC.CODDIV=PEC.CODDIV AND BUC.ANOPED=PEC.ANOPED AND BUC.SEQPED=PEC.SEQPED AND
                                           PEC.SWTNOETIQCC!='S' AND PEC.CODSERIEPREP=SPR.CODSERIEPREP AND SPR.CODSERIEPREP=:CODSERIEPREP);

CURSOR=CASIGNAREC UPDATE VDRECURSO SET STATUS=VDST.FRECASIGNADO,CODPERFIL='BULBCEPREV',
                                       FECMODIF=VD.FECHASYS,HORAMODIF=VD.HORASYS
                                 WHERE CODRECURSO=:CODRECURSO;

CURSOR=CUPDBULTO UPDATE VDBULTOCAB SET STATUS=VDST.FBUCBULABANETI,CODRECURSO=:CODRECURSO,SWTLLEVAALB=DECODE(:LLEVAALB,'S','S',''),
                                       CODOPEIMPRIME=VDUSER.GETUSER,FECIMPRIME=VD.FECHASYS,HORAIMPRIME=VD.HORASYS
                  WHERE CODBULTO=:CODBULTO;

CURSOR=CLLEVAALB SELECT VDBULTO.DAMEULTBULTOBULB(:CODBULTO) LLEVAALB FROM DUAL;

CURSOR=CSELALB SELECT 1 DUMMY FROM DUAL WHERE :LLEVAALB='SI' AND :PROFORMA='N';           
    
TECLA=SF10,FLEEMENU("SGLBULAB.ZOO")

AYUDA=GESTIÓN MANUAL DE BULABANES
ONLINE=     {F1} Ayuda          {F2} Consulta          {F4} Confirmar cambios       {F5} Borrar pantalla
                               {May-F10} Menú                 {Esc} Salir;

