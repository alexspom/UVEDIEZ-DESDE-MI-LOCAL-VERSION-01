MANTENIMIENTO DE DEVOLUCIONES

   Código _20_________ Cliente _20____________ _40____________________________
   Referencia _255___
   Observaciones: _255________________________________________________________
                  _255________________________________________________________
                  _255________________________________________________________
   Estado     @L@@@ _40______________________________  
   Inserción  _______________ ¿D-MM-Y.YY ________
   Validación _______________ ¿D-MM-Y.YY ________
   Modifica   _______________ ¿D-MM-Y.YY ________

|

TABLA=VDDEVOLCAB
NOINSERT
NODELETE,PROTECT("IMPLANTADOR")
POSX=1



PREUPDATE=FEJECUTA("CSELOPEMODIF","No puedo poner usuario ultima modificación")

CAMPO=SEQDEVOL,NOUPDATE,TOOLTIP("Código de la devolución"),INCLUDECSS="height:16px;COLOR:DARKBLUE;font-style:bold;border-style:ridge;background-color:#F7BE81;",WLONX=6
CAMPO=CODCLIENTE,UPPER,POSTCHANGE=FVALNOCERO("Debe introducir Código de cliente"),INCLUDECSS="height:16px;COLOR:DARKBLUE;font-style:bold;border-style:ridge;background-color:#F7BE81;",WLONX=6
CAMPO=DESCLIENTE,UPPER
CAMPO=OBSERVA4
CAMPO=OBSERVA1
CAMPO=OBSERVA2
CAMPO=OBSERVA3
CAMPO=STATUS,PROTECT("SUPERVISOR"),POSTCHANGE=FDESIGNACION("CSELSTATUS","No existe estado"),COMBOX("CSELCOMBOST")
CAMPO=DESSTATUS,AUXILIAR,NOENTER
CAMPO=CODOPEINS,NOENTER
CAMPO=FECINS,NOENTER
CAMPO=HORAINS,NOENTER
CAMPO=CODOPEVALIDA,NOENTER
CAMPO=FECVALIDA,NOENTER
CAMPO=HORAVALIDA,NOENTER
CAMPO=CODOPEMODIF,NOENTER
CAMPO=FECMODIF,NOENTER
CAMPO=HORAMODIF,NOENTER

CURSOR=CLISTADIVIS SELECT CODDIV, DESDIV FROM VDDEVOLDIVIS ORDER BY DECODE(CODDIV,NULL,1,0),CODDIV;

CURSOR=CSELDIVIS SELECT DESDIV FROM VDDEVOLDIVIS WHERE NVL(CODDIV,'-') = NVL(:CODDIV,'-');

CURSOR=CSELCOMBOST SELECT STATUS,DESSTATUS FROM VDSTATUS WHERE TIPOSTATUS = 'DVC' ORDER BY STATUS;

CURSOR=CSELCOMBPAIS SELECT CODPAIS,DESPAIS FROM VDPAIS;

CURSOR=CSELCOMBPROV SELECT DISTINCT CODPROV,DESPROV,PROV.CODPAIS,DESPAIS FROM VDPROVI PROV, VDPAIS PA
                             WHERE PROV.CODPAIS=PA.CODPAIS ORDER BY DECODE(CODPAIS,:CODPAIS,0,1);

CURSOR=CSELPAIS SELECT DESPAIS FROM VDPAIS WHERE CODPAIS=:CODPAIS OR :CODPAIS IS NULL;

CURSOR=CSELDESPROV SELECT DESPROV FROM VDPROVI PROV, VDPAIS PA
                             WHERE PROV.CODPAIS=PA.CODPAIS AND CODPROV=:CODPROV AND PROV.CODPAIS=:CODPAIS;

CURSOR=CSELSTATUS SELECT DESSTATUS FROM VDSTATUS WHERE STATUS=:STATUS AND TIPOSTATUS='DVC';


CURSOR=CSELOPEMODIF SELECT VDUSER.GETUSER CODOPEMODIF,VD.FECHASYS FECMODIF,VD.HORASYS HORAMODIF
                    FROM DUAL;

CURSOR=CINCCAJASCLIENTE UPDATE VDDEVOLCAB SET    CAJASCLIENTE = NVL(CAJASCLIENTE,0) + 1,
                                                 CODOPEMODIF  = VDUSER.GETUSER,
                                                 FECMODIF     = VD.FECHASYS,
                                                 HORAMODIF    = VD.HORASYS
                                      WHERE SEQDEVOL = :SEQDEVOL;

CURSOR=CCHECKDEVOL SELECT TO_NUMBER(:SEQDEVOL) SEQDEVOL FROM DUAL WHERE TO_NUMBER(:SEQDEVOL) > 0;

CURSOR=CFINDEVOL UPDATE VDDEVOLCAB
                    SET STATUS=VDVST.FDVCFINALIZADA,
                        CODOPEMODIF=VDUSER.GETUSER,
                        FECMODIF=VD.FECHASYS,
                        HORAMODIF=VD.HORASYS
                  WHERE SEQDEVOL = :SEQDEVOL;

CURSOR=CIMPREPROTOCOLO SELECT :SEQDEVOL FROM DUAL
                        WHERE VD.GETPROP('IMPRIMEPROTOCOLO')='S';

CURSOR=CSELDVLAPTO SELECT :SEQDEVOL
                     FROM VDDEVOLLIN
                    WHERE SEQDEVOL=:SEQDEVOL AND STATUS=VDVST.FDVLAPTO;

CURSOR=CBORRABULTO SELECT 0 NBULTO FROM DUAL;

CURSOR=CSELNBULTO SELECT TO_NUMBER(:NBULTO)+1 NBULTO FROM DUAL
                    WHERE :NBULTO<:NUMBULTOS;

CURSOR=CSELMAXCAJAS SELECT NVL(MAX(NUMCAJA),'0') MAXCAJAS
                      FROM VDDEVOLLIN
                     WHERE SEQDEVOL=:SEQDEVOL AND STATUS IN (VDVST.FDVLDEVCLIENTE,VDVST.FDVLDEVEXT) AND NUMCAJA>0;

CURSOR=CBORRACAJA SELECT 0 NUMCAJA FROM DUAL;

CURSOR=CNOHAYCAJAS SELECT :SEQDEVOL FROM DUAL WHERE :MAXCAJAS=0;

CURSOR=CSELNCAJA SELECT TO_NUMBER(:NUMCAJA)+1 NUMCAJA FROM DUAL
                  WHERE :NUMCAJA<:MAXCAJAS;

CURSOR=CIMPRIMECAJA SELECT :SEQDEVOL
                      FROM VDDEVOLLIN
                     WHERE SEQDEVOL=:SEQDEVOL AND STATUS IN (VDVST.FDVLDEVCLIENTE,VDVST.FDVLDEVEXT) AND NUMCAJA=:NUMCAJA;

CURSOR=CUPDDVLACLIENTE UPDATE VDDEVOLLIN
                          SET STATUS=VDVST.FDVLDEVEXT
                        WHERE SEQDEVOL=:SEQDEVOL AND STATUS=VDVST.FDVLDEVCLIENTE;

CURSOR=CSTATUSDVC SELECT :STATUS STATUSDVC FROM DUAL;

CURSOR=CVALIDADEV  UPDATE VDDEVOLCAB SET STATUS = VDVST.FDVCESCANEADA,
                                         CODOPEVALIDA  = VDUSER.GETUSER, FECVALIDA   = VD.FECHASYS, HORAVALIDA   = VD.HORASYS,
                                         CODOPEMODIF  = VDUSER.GETUSER, FECMODIF     = VD.FECHASYS, HORAMODIF    = VD.HORASYS
                      WHERE SEQDEVOL = :SEQDEVOL AND STATUS=VDVST.FDVCENCURSO;

TECLA=SF2,FEJECUTA("CCHECKDEVOL","DEBE SELECCIONAR UNA DEVOLUCION",
                   "CVALIDADEV","ERROR VALIDANDO DEVOLUCION",
                   FIF("CIMPREPROTOCOLO",
                       FEJECUTA(FIMPRIME("INFORME","DEVOLUCIONES.RPT","FORMSEQDEVOL=:SEQDEVOL","",""),":V10ERROR",
                                FIF("CSELDVLAPTO",FIMPRIME("INFORME","VDBOLETINBE.RPT","FORMSEQDEVOL=:SEQDEVOL","","")),""),
                       FSUCCESS),"ERROR IMPRIMIENDO PROTOCOLO",
                           FCOMMIT,"")


TECLA=SF3,FEJECUTA("CCHECKDEVOL","DEBE SELECCIONAR UNA DEVOLUCION",
                   FSQL2EXCEL("SELECT VDDEVOL.DAMEARTACTIVO(LD.CODART) CODART,SUM(LD.CANTIDAD) CANTIDAD,AR.DESART "
                                " FROM VDDEVOLLIN LD,VDARTIC AR "
                                " WHERE LD.SEQDEVOL=:SEQDEVOL AND AR.CODART=LD.CODART AND LD.ABONABLE='S'"
                               " GROUP BY LD.CODART,AR.DESART"
                               " ORDER BY AR.DESART",
                              "","0","1",""),"")

TECLA=SF4,FEJECUTA("CBORRABULTO","",
                   FWHILE("CSELNBULTO",
                          FIMPRIME("ETIQ","VDDEVOL.GEN;VDDEVOL.VSQ;CSELDEVOL","SEQDEVOL=:SEQDEVOL;NBULTO=:NBULTO",""),":V10ERROR"),":V10ERROR")

TECLA=SF5,FEJECUTA("CCHECKDEVOL","DEBE SELECCIONAR UNA DEVOLUCION",
                   "CVALIDADEV","ERROR VALIDANDO DEVOLUCION",
                   FIF("CIMPREPROTOCOLO",
                       FEJECUTA(FIMPRIME("INFORME","DEVOLUCIONESCLI.RPT","FORMSEQDEVOL=:SEQDEVOL","",""),":V10ERROR"),
                       FSUCCESS),"ERROR IMPRIMIENDO PROTOCOLO",
                           FCOMMIT,"")

TECLA=SF7,FEJECUTA("CCHECKDEVOL","DEBE SELECCIONAR UNA DEVOLUCION",
                   "CFINDEVOL","ERROR FINALIZANDO DEVOLUCION",
                   FCOMMIT,"",
                   %FFAILURE,"DEVOLUCION FINALIZADA",
                   FPULSATECLAS("CF2","CF2","F2"),"")

TECLA=SF8,FEJECUTA("+CSELMAXCAJAS","",
                   "CBORRACAJA","",
                   FIF("CNOHAYCAJAS",FEJECUTA(FFAILURE,"DEVOLUCION SIN CAJAS"),
                                     FEJECUTA(FWHILE("CSELNCAJA",
                                                     FIF("CIMPRIMECAJA",FIMPRIME("INFORME","PACKINGLISTCC.RPT","PSEQDEVOL=:SEQDEVOL;PNUMCAJA=:NUMCAJA","","")),"ERROR IMPRIMIENDO PACKING LIST"),":V10ERROR",
                                              "CUPDDVLACLIENTE","ERROR ACTULIZANDO LINEAS DE DEVOLUCION",
                                              FCOMMIT,"")),"NO SE PUEDE DEVOLVER A CLIENTE",
                   %FFAILURE,"DEVOLUCION DEVUELTA A CLIENTE",
                   FPULSATECLAS("CF2","CF2","F2"),"")

BOTON=VALIDAR,1066,140,110,45,"Confirmar",NO,F4,"Confirmar Cambios"
BOTON=EXCEL,1066,195,110,45,"Excel",NO,SF3,"Excel"
BOTON=IMPRIMIR,1066,250,110,45,"Imprimir informe",NO,SF2,"Imprimir informe"
BOTON=IMPRIMIRCLI,1066,305,110,45,"Imprimir informe\n Cliente",NO,SF5,"Imprimir informe cliente"
BOTON=IMPREETIQ,1066,360,110,45,"Imp. Etiquetas\nDevolución",NO,SF4,"Imprimir etiquetas de devolución"
BOTON=FINALIZAR,1066,415,110,45,"Finalizar",NO,SF7,"Finalizar"
BOTON=ACLIENTE,1066,470,110,45,"Devolver a cliente",NO,SF8,"Devolver a cliente"

ONLINE={S-F2} Impresion de informe {SF3} Pasa a Excel {SF4} Etiqueta de bulto {F4} Confirmar cambios {F3} Limpiar pantalla {Esc} Salir;
